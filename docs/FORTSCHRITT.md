# Projektfortschritt - FitBuddy App

> Chronologische Dokumentation aller Projektschritte.

---

## Versionshistorie

| Version | Datum      | Beschreibung                                       | Status     |
|---------|------------|-----------------------------------------------------|------------|
| 0.1     | 2026-02-16 | Projektstruktur angelegt                            | Erledigt   |
| 0.2     | 2026-02-16 | Expertenpanel (14 Rollen) definiert                 | Erledigt   |
| 0.3     | 2026-02-16 | Lovable Prompt-Historie analysiert                  | Erledigt   |
| 0.4     | 2026-02-16 | Anforderungen extrahiert, Scope definiert           | Erledigt   |
| 0.5     | 2026-02-16 | Lovable-Quellcode erhalten und analysiert           | Erledigt   |
| 0.6     | 2026-02-16 | TypeScript-Typen rekonstruiert                      | Erledigt   |
| 0.7     | 2026-02-16 | Architektur-Entwurf erstellt                        | Erledigt   |
| 0.8     | 2026-02-16 | Projektplan finalisiert (v2.0)                      | Erledigt   |
| 0.9     | 2026-02-16 | Wissenschaftliche Grundlagen dokumentiert            | Erledigt   |
| 1.0     | 2026-02-16 | Architektur finalisiert (v2.0)                      | Erledigt   |
| 1.1     | 2026-02-16 | Phase 2 abgeschlossen, alle Dokumente aktualisiert  | Erledigt   |
| 2.0     | 2026-02-16 | Phase 3a: Projekt-Grundgeruest aufgebaut             | Erledigt   |
| 2.1     | 2026-02-17 | Phase 3b: Daten-Features & UI-Dialoge               | Erledigt   |
| 2.2     | 2026-02-17 | Phase 3c: KI-Buddy (Multi-Agent + Action-Parsing)    | Erledigt   |
| 2.3     | 2026-02-17 | Phase 3d: Erinnerungssystem (Reminders)              | Erledigt   |
| 2.4     | 2026-02-17 | Phase 3e: Empfehlungen & Insights                    | Erledigt   |
| 2.5     | 2026-02-17 | Bugfix-Runde 1: 8 High/Medium-Bugs                   | Erledigt   |
| 2.6     | 2026-02-17 | Bugfix-Runde 2: 8 verbleibende Bugs (i18n, Closures, Auth, Queries) | Erledigt   |
| 3.0     | 2026-02-17 | Trainingsplaner: KI-gesteuerte Plan-Verwaltung       | Erledigt   |
| 3.1     | 2026-02-17 | UI-Polish: Konsistente Darstellung                   | Erledigt   |
| 3.2     | 2026-02-18 | Testing + Code-Review: 73 Tests + 6 Fixes            | Erledigt   |
| 3.3     | 2026-02-18 | Streaming-Fix: Echtzeit-Streaming fuer Buddy-Chat    | Erledigt   |
| 4.0     | 2026-02-18 | Multi-Agent Routing + Crash-Fix + Prompt-Verstaerkung | Erledigt   |
| 4.1     | 2026-02-18 | Browser-Live-Tests: 12/12 bestanden                   | Erledigt   |
| 4.2     | 2026-02-18 | Bugfixes: useDeleteSubstance, i18n-Keys, Error-Feedback | Erledigt   |
| 4.3     | 2026-02-19 | User-Produkt-DB + OpenAI Provider (gpt-4o-mini)      | Erledigt   |
| 4.4     | 2026-02-19 | Fakten-Codex + Markenprodukte-Seed (11 Produkte)     | Erledigt   |
| 4.5     | 2026-02-19 | Reports Feature: 5 Charts, 3 Tabs, Aggregations-Hooks | Erledigt   |
| 4.6     | 2026-02-19 | Kalorien-Bilanz + Trainingsplan-PDF                    | Erledigt   |
| 4.7     | 2026-02-19 | add_substance + add_reminder Actions                    | Erledigt   |
| 4.8     | 2026-02-19 | PDF Logbuch-Variante (Landscape A4)                     | Erledigt   |
| 4.9     | 2026-02-19 | Voice Input KOMPLETT (Web Speech API, 320-Zeilen Hook)  | Erledigt   |
| 5.0     | 2026-02-20 | Trainingsplan-Editor via KI-Agent (Chat-Edits)          | Erledigt   |
| 5.1     | 2026-02-20 | Wissenstransfer: 3 Skills + 2 Agenten (Beauty/Lifestyle)| Erledigt   |
| 5.2     | 2026-02-20 | Push Notifications + Social Media Planung               | Erledigt   |
| 5.3     | 2026-02-20 | Phase 8.1: Capacitor + Push Notifications (17 Dateien)  | Erledigt   |
| 5.4     | 2026-02-20 | Medical-Agent — 8. Agent (Sportmedizin, Kardio, Endokri) | Erledigt   |
| 5.5     | 2026-02-20 | Conversational Onboarding + update_profile Action        | Erledigt   |
| 5.6     | 2026-02-20 | Persoenliche Ziele im Profil — Buddy kennt User-Goals    | Erledigt   |
| 5.7     | 2026-02-20 | Proaktive Suggestion Chips im Buddy-Chat                 | Erledigt   |
| 5.8     | 2026-02-20 | BuddyQuickAccess — "Frag den Buddy" auf jeder Seite     | Erledigt   |
| 5.9     | 2026-02-20 | Block B: Cockpit-Redesign + Navigation 8→5               | Erledigt   |
| 6.0     | 2026-02-20 | Block C: Inline Buddy Chat + Voice Auto-Send             | Erledigt   |
| 6.1     | 2026-02-21 | Email & Auth: Resend SMTP, Confirmation, ResetPasswordPage | Erledigt   |
| 6.2     | 2026-02-21 | Admin-Dashboard: Nutzerstatistiken, Token-Logging, Food-DB | Erledigt   |
| 6.3     | 2026-02-21 | Geraetepark: Equipment-Katalog, Gym-Profile, Trainer-Integration | Erledigt   |
| 6.4     | 2026-02-21 | Screenshot-Import: Fitdays-Bilder per Vision-KI auswerten | Erledigt   |
| 6.5     | 2026-02-21 | Proaktive Agenten: Tagesform-Check, Abweichungs-Erkennung | Erledigt   |
| 6.6     | 2026-02-21 | Tests + CI/CD + Konzepte (Trainingsarten, Videos, Social) | Erledigt   |
| 6.7     | 2026-02-22 | Trainingsarten + Uebungskatalog + Profilbild (3 Features) | Erledigt   |
| 6.8     | 2026-02-21 | Social Stufe 1 + Lint-Fix + Deployment-Doku              | Erledigt   |
| 6.9     | 2026-02-21 | Test-Ausbau 239→1210 (5 neue Test-Dateien, i18n-Konsistenz) | Erledigt   |
| 7.0     | 2026-02-22 | 7 UX-Verbesserungen aus Live-Test (1323 Tests)               | Erledigt   |
| 7.1     | 2026-02-22 | Produkt-Recherche + Ehrlichkeits-Regeln + Zielberechnung     | Erledigt   |
| 8.0     | 2026-02-24 | Disclaimer + P2-Features (Prognosen, Silhouette, Import)      | Erledigt   |
| 8.1     | 2026-02-24 | Edge Function ai-proxy + DataImport BP/Mapping + Deploy-Prep  | Erledigt   |
| 8.2     | 2026-02-24 | Hetzner Deployment-Infrastruktur (Docker Compose, Caddy, CI/CD) | Erledigt   |
| 9.0     | 2026-02-25 | User-Feedback-Modul + Validierung/Security/Auth-Tests (1618 Tests) | Erledigt   |
| 9.1     | 2026-02-25 | Component-Tests + Integration-Tests (1729 Tests)                   | Erledigt   |
| 9.2     | 2026-02-25 | Production-Deployment fudda.de — Frontend-Fix + www-Redirect       | Erledigt   |
| 9.3     | 2026-02-25 | Live Workout Session + Personal Trainer Phase 1 (1938 Tests)       | Erledigt   |
| 9.4     | 2026-02-26 | Timer-Features + E2E-Tests + Accessibility + Live-Test (1991 Tests) | Erledigt   |
| 9.5     | 2026-02-26 | Navigation-Redesign: Ernaehrung + Training auf erste Ebene (1995 Tests) | Erledigt   |
| 9.6     | 2026-02-26 | Musik-Streaming beim Training (YouTube-Player)                          | Erledigt   |
| 9.7     | 2026-02-26 | KI-Zeitvorschlaege: Pausen/Aufwaermen/Haltezeiten (2016 Tests)          | Erledigt   |
| 9.8     | 2026-02-26 | Audio-Steuerung: Sprachbefehle fuer Workout-Sessions (2051 Tests)       | Erledigt   |
| 9.9     | 2026-02-26 | P2: Mobile Responsiveness + Lighthouse + RLS-Tests (2095 Tests)         | Erledigt   |
| 10.0    | 2026-02-26 | Welcome-Email, Git-Workflow, shadcn/ui, CI/CD Deploy (2095 Tests)       | Erledigt   |
| 10.1    | 2026-02-26 | Production-Deploy v10.0 + Edge Functions Env + GoTrue SMTP              | Erledigt   |
| 10.2    | 2026-02-26 | Deep-Test Production: 8 Features geprueft, 4 Bugs gefunden              | Erledigt   |
| 10.3    | 2026-02-26 | 4 Bug-Fixes + Production-Deployment + Verifikation                       | Erledigt   |
| 10.4    | 2026-02-27 | 5 neue Skills, Agent-Verbesserungen, Bildkomprimierung, Registrierung    | Erledigt   |
| 10.5    | 2026-02-27 | DNS-Infrastruktur: Hetzner DNS + Strato NS-Umstellung + Resend Records  | Erledigt   |
| 10.6    | 2026-02-27 | i18n 17 Sprachen, Skills Quellen-Audit, Rechtskonformitaet              | Erledigt   |
| 10.7    | 2026-02-27 | Chat-Trennung pro Agent (AgentThreadTabs, Routing-Bypass)                | Erledigt   |
| 10.8    | 2026-02-27 | Celebrations (Konfetti+Toast), 24 Substanz-Presets                       | Erledigt   |
| 10.9    | 2026-02-27 | Power/Power+ Modus — Phase A komplett                                    | Erledigt   |
| 10.9a   | 2026-02-27 | Musik/Timer Analyse + Konzept (MUSIK_TIMER_KONZEPT.md)                   | Erledigt   |
| 11.0    | 2026-02-28 | Musik & Timer Overhaul komplett (4 Phasen, +32 Tests, Spotify SDK)       | Erledigt   |
| 11.1    | 2026-02-28 | Glossar-Skill: 400+ Fachbegriffe in 12 Kategorien, allen Agents zugewiesen | Erledigt   |
| 11.2    | 2026-02-28 | Digital Twins: 25 Personas + Testing Report (10 UX-Issues, 5 Safety, 17 Feature-Requests) | Erledigt   |
| 11.3    | 2026-02-28 | Twin-Testing Sofortmassnahmen: 5 Fixes (KI-Mahlzeit, Profil-Felder, Reminder, Disclaimer, Datum) | Erledigt   |
| 11.4    | 2026-02-28 | Profil-Daten an KI-Context + Gender Feature-Gating Hook                  | Erledigt   |
| 11.5    | 2026-02-28 | DSGVO-Komplett: Impressum, Datenschutz, Granulare Consents, Account-Löschung, Widerrufsrecht | Erledigt   |

---

### 2026-02-28 - v11.7: Rechtskonformitaet Phase 2 — Disclaimer-Suite (E.2.2-E.2.5)

**E.2.2: KI-Disclaimer:**
- ChatMessageBubble: "KI-generiert — kann Fehler enthalten. Keine medizinische Beratung." unter jeder KI-Antwort
- Nur bei fertigen (nicht streamenden), fehlerfreien Nachrichten
- 17 Sprachen (buddy.aiDisclaimer Key)

**E.2.3: BP-Klassifikation:**
- MedicalPage: Disclaimer-Footer unter Blutdruck-Liste "Klassifikation nach ESC/ESH 2023. Informativ, keine Diagnose."
- AddBloodPressureDialog: Disclaimer unter Live-Preview
- 17 Sprachen (medical.bpDisclaimer Key)

**E.2.4: PED-Disclaimer:**
- MedicalPage: PED-Substanzen mit Amber-Badge (⚠ PED) statt grauem Badge
- MedicalPage + LogSubstanceDialog: Amber PED-Disclaimer-Footer wenn PED/TRT vorhanden
- LogSubstanceDialog: PED-Substanzen mit Amber-Rahmen + ⚠ PED Badge
- 17 Sprachen (medical.pedDisclaimer Key)

**E.2.5: Substanz-Agent Haertung:**
- Neuer HAFTUNGS-REGELN Block im System-Prompt (DE + EN):
  - KEINE Dosierungsempfehlungen (nur Nutzer-genannte Dosen dokumentieren)
  - KEINE Wirksamkeitsaussagen — stattdessen "Studien zeigen..."
  - KEINE Zyklus-Planung (außer Power+ Modus)
  - Pflicht-Disclaimer am Ende jeder PED-Antwort

**Dateien:** ChatMessage.tsx, MedicalPage.tsx, AddBloodPressureDialog.tsx, LogSubstanceDialog.tsx, substanceAgent.ts, 17 i18n-Dateien

---

### 2026-02-28 - v11.6: Cockpit Standard-Ziele ohne Profil (P1-4)

**Problem:** Cockpit zeigte 2000 kcal / 150g Protein als Ziele, obwohl Profil leer — irrefuehrend.

**Loesung:**
- `profileComplete`-Check: height_cm + birth_date + weight_kg muessen vorhanden sein
- CTA-Card "Persoenliche Tagesziele einrichten" (Target-Icon, Link zu /profile) bei leerem Profil
- Makro-Werte weiterhin sichtbar, aber OHNE Fortschrittsbalken und "verbleibend"-Text
- "Kein Ziel gesetzt" statt irrefuehrender Default-Ziele
- Celebrations nur bei profileComplete (keine falschen Goal-Achievements)
- CalorieChart ohne Ziellinie bei leerem Profil
- Energy Balance ohne rot-Markierung bei leerem Profil
- BMR/TDEE-CTA durch oberen CTA ersetzt (kein doppelter CTA)
- i18n: 3 neue cockpit-Keys in 17 Sprachen

**Dateien:** CockpitPage.tsx (modifiziert), de.ts + en.ts + 15 weitere (3 Keys)

---

### 2026-02-28 - v11.5: DSGVO-Komplett (5 Rechtskonformitaets-Features)

**E.1.2+E.1.1: Impressum + Datenschutzerklaerung:**
- /impressum Route (§5 DDG): Anbieterinfo, Haftung, Urheberrecht, Medizin-Disclaimer
- /datenschutz Route (Art. 13/14 DSGVO): 10 Abschnitte (Verantwortlicher, Art.9, KI, Hosting DE, Cookies, Drittdienste, Rechte)
- Oeffentliche Seiten (kein Login noetig), Legal-Footer auf Login + Register
- i18n: legal + privacy Keys in 17 Sprachen (88 Keys)

**E.1.3: Granulare Einwilligungen:**
- 3 separate Consents statt 1 Checkbox: Gesundheitsdaten (Art. 9), KI-Verarbeitung, Drittlandtransfer (Art. 49)
- DB-Migration: consent_health_data_at, consent_ai_processing_at, consent_third_country_at
- DisclaimerModal mit 4 Checkboxen, Links zu /datenschutz + /impressum
- useDisclaimerCheck v2: Prueft alle 3 Consents

**E.1.6: Account-Loeschung (Art. 17):**
- DB-Funktion delete_user_account() (SECURITY DEFINER): CASCADE-Loeschung aller Daten
- useDeleteAccount Hook + DeleteAccountDialog mit Bestaetigungswort
- ProfilePage: "Account loeschen" Button

**E.1.7: Widerrufsrecht (Art. 7 Abs. 3):**
- PrivacySettings Komponente: 3 Consent-Karten mit Status-Anzeige
- Jede Einwilligung einzeln widerrufbar mit Warnung
- localStorage-Cache wird bei Widerruf geloescht → DisclaimerModal erneut

Neue Dateien: ImpressumPage, DatenschutzPage, DeleteAccountDialog, useDeleteAccount, PrivacySettings, 2 DB-Migrationen
Commits: a1d1d2f, b92e5c0, 025a5f7, 284aade

### 2026-02-28 - v11.4: Profil-Daten an KI-Context + Gender Feature-Gating

**Profil-Daten an KI-Agents (SICHERHEITSRELEVANT):**
- `generateProfileSkill()` in userSkills.ts erweitert
- Allergien mit WARNING-Direktive: "NIEMALS Allergene empfehlen!"
- Gesundheitseinschraenkungen mit WARNING: "IMMER beruecksichtigen!"
- Ernaehrungsform (Vegetarisch etc.) als Kontext
- Buddy kennt jetzt Erdnussallergie, Rektusdiastase, Vegetarismus

**Gender-basiertes Feature-Gating:**
- Neuer Hook: `useGenderFeatures()` in `src/shared/hooks/useGenderFeatures.ts`
- 12 Feature-Flags: showCycleTracker, showSymptomTracker, showREDSWarning, showBreastfeedingToggle, showDiastasisRecti, showProstateMarkers, useMaleTestosteroneRef, etc.
- Pattern: Analog zu useTrainingMode() — liest Gender aus useProfile()
- female: Zyklus, Symptome, RED-S, Stillen, Rektusdiastase
- male: Prostata (nur >40), Testosteron-Referenzen
- other: ALLE Features sichtbar (Nutzer waehlt)
- Altersberechnung aus birth_date fuer Prostata-Marker

Commits: 86c75b7 (Profil-Daten), 6703b90 (Gender Hook)

### 2026-02-28 - v11.3: Twin-Testing Sofortmassnahmen

5 Top-Priority-Fixes aus dem Digital-Twin-Testing-Report implementiert:

1. **Fix #3: PED-Disclaimer** — Disclaimer wird bei Tab-Wechsel korrekt zurueckgesetzt (nur bei TRT/PED)
2. **Fix #9: Datumsformat** — Mahlzeit-Tab zeigt jetzt de-DE Format (28.02.2026 statt ISO)
3. **Fix #8: Mahlzeit-Reminder** — Neuer Typ `meal_logging` mit i18n in 17 Sprachen + 5er-Grid
4. **Fix #1: KI-Mahlzeit-Schaetzung** — Sparkles-Button im Mahlzeit-Dialog: Name eingeben, KI schaetzt Kalorien/Makros via ai-proxy
5. **Fix #2+#4: Profil Ernaehrung & Gesundheit** — Neue Sektion mit Chip-Auswahl:
   - Ernaehrungsform (Vegetarisch, Vegan, Pescatarisch, Halal, Koscher, Laktosefrei, Glutenfrei)
   - Allergien (Nuesse, Gluten, Laktose, Schalentiere, Eier, Soja, Weizen)
   - Gesundheitliche Einschraenkungen (Ruecken, Schulter, Knie, Huefte, Handgelenk, Nacken, Rektusdiastase)

Neue Dateien: `useEstimateMealNutrition.ts`, DB-Migration `20260228000001_profile_dietary_health.sql`
Geaenderte Dateien: 25 (17 i18n + 8 Components/Types)
Commit: 99175bf

### 2026-02-28 - v11.2: Digital Twins Testing

25 detaillierte Nutzer-Personas in 5 Gruppen (Einsteiger/Fortgeschrittene/Power/Enhanced/Frauen).
Systematisches Testing via Preview + Source-Code-Analyse. Ergebnis:
- 10 kritische UX-Findings (Mahlzeit-Dialog, Onboarding, Allergien, Zyklus-Tracking)
- 5 sicherheitsrelevante Findings (Allergie-Risiko, RED-S, Rektusdiastase, Haematokrit)
- 17 priorisierte Feature-Requests (P0-P2)
- Top-5 Sofort-Massnahmen identifiziert

Neue Dokumente: `DIGITAL_TWINS.md`, `TWIN_TESTING_REPORT.md`
Commits: 2b48ebe, e1d9dfc

### 2026-02-28 - v11.1: Glossar-Skill (Fachwoerterbuch)

400+ Fachbegriffe in 12 Kategorien: Training, Ernaehrung, Koerperzusammensetzung,
Supplements, PEDs, PCT, Medizin/Labor, Schlaf, Wettkampf, Female Fitness, Beauty, Abkuerzungen.
Extrahiert aus allen 15 bestehenden Skills. Allen 8 Agents zugewiesen.

Neue Datei: `src/lib/ai/skills/glossary.ts` (~4.500 Tokens)
Commit: de14bdd

### 2026-02-28 - v11.0: Musik & Timer Overhaul (4 Phasen)

**Phase 1:** YouTube IFrame API Fix (YT.Player, sichtbarer Mini-Player), ESLint 5→0 Errors
**Phase 2:** Tabellarischer Multi-Timer (5 Sektionen, Auto-Advance, Web Audio Alerts)
**Phase 3:** Alte Timer entfernt + 32 neue Tests (alle gruen)
**Phase 4:** Spotify Web Playback SDK (OAuth, Edge Function, Tab-Toggle YouTube/Spotify)

Neue Dateien: 10, Modifizierte: 28+, Tests: 2.127 (2.095 + 32)
Commits: 5f631d7, 512b40a, b007fba, 96bea23

## Log

### 2026-02-27 - v10.9: Power/Power+ Trainingsmodus (Phase A)

**Bodybuilder-Modus: Standard / Power / Power+**

Vollstaendige Implementierung des dreistufigen Trainingsmodus-Systems:

| Komponente | Status | Details |
|------------|--------|---------|
| DB-Migration | ✅ | training_mode, cycle_status, blood_work Tabelle (25+ Lab-Werte) |
| Types | ✅ | TrainingMode, TrainingPhase, CycleStatus, BloodWork Interface |
| useTrainingMode Hook | ✅ | ~20 Feature-Flags (showPEDContent, showBloodWork, showCycleTracker, etc.) |
| TrainingModeSelector | ✅ | 3-Card UI (Standard/Power/Power+), Power+ Disclaimer Modal |
| ProfilePage Integration | ✅ | Selector eingebunden, Auto-Save, power_plus_accepted_at |
| Anabolics Skill v3.0 | ✅ | +2.400 Tokens: 4 Ziel-Zyklen, 11 Wechselwirkungen, Ester-Tabelle, Monitoring |
| Modus-bewusstes Skill-Loading | ✅ | getSkillIdsForMode() — Power+ bekommt anabolics_powerplus Extension |
| Agent Training-Mode-Kontext | ✅ | Alle Agents wissen welcher Modus aktiv ist |
| Substance Agent Power+ | ✅ | Volle Zyklus-Beratung, Dosierungen, BloodWork-Logging |
| useUpdateProfile erweitert | ✅ | +8 neue Felder (training_mode, cycle_status, show_date, etc.) |

**Konzept:** docs/BODYBUILDER_MODUS_KONZEPT.md (2 Personas, Digital Twins, Experten-Challenge)

### 2026-02-27 - v10.5: DNS-Infrastruktur fuer Email-Verifizierung

**DNS-Umzug von Strato zu Hetzner DNS (autonom via Browser-Automation):**

| Schritt | Status | Details |
|---------|--------|---------|
| Hetzner DNS Zone erstellen | ✅ | Zone 919094, Projekt 13589003 |
| A-Record: @ → 46.225.228.12 | ✅ | Webserver erreichbar |
| CNAME: www → fudda.de | ✅ | www-Subdomain |
| TXT: resend._domainkey (DKIM) | ✅ | RSA Public Key fuer DKIM-Signierung |
| TXT: send (SPF) | ✅ | v=spf1 include:amazonses.com ~all |
| MX: send → feedback-smtp.eu-west-1.amazonses.com. | ✅ | Priority 10, Trailing-Dot Fix |
| Strato NS → Hetzner | ✅ | hydrogen/oxygen/helium.ns.hetzner |
| DNS-Propagation | ⏳ | Bis 24h, Google DNS zeigt noch Strato |
| Resend Domain-Verifizierung | ⏳ | Wartet auf DNS-Propagation |

**Technische Details:**
- Hetzner DNS Zone ID: 919094 (Projekt: 13589003)
- Resend Domain ID: 395dd33d-e3ba-4721-b04a-87b718bff886 (Region: eu-west-1)
- MX-Record Trailing-Dot Fix: Ohne abschliessenden Punkt wurde Zone-Name angehaengt (feedback-smtp...com.fudda.de statt feedback-smtp...com)
- Strato bleibt Domain-Registrar, nur NS-Delegation geaendert
- Alle Records per nslookup gegen hydrogen.ns.hetzner.com verifiziert ✅

**Naechste Schritte (nach DNS-Propagation):**
1. Resend Domain verifizieren (SPF + DKIM + MX)
2. GOTRUE_MAILER_AUTOCONFIRM=false setzen
3. Email-Confirmation-Flow testen

---

### 2026-02-27 - v10.4: 5 neue Skills, Agent-Verbesserungen, Bildkomprimierung, Registrierung

**5 neue Wissensdateien (Skills v2.0):**
| Skill | Zeilen | Inhalt |
|-------|--------|--------|
| sleep.ts | 141 | Schlafphasen, HRV, Melatonin, Overtraining, Schlafhygiene |
| supplements.ts | 132 | 30+ Supplements, A/B/C/D Evidence-Grading, Interaktionen |
| pct.ts | 127 | HPG-Achse, ASIH, Recovery-Timelines, Laborkontrolle |
| competition.ts | 123 | Natural vs Enhanced Prep, Peak Week, Reverse Diet |
| femaleFitness.ts | 167 | Zyklus-Training, Schwangerschaft, Menopause, RED-S |

**Agent-Verbesserungen:**
- baseAgent: Schaetzungs-Kennzeichnungspflicht, Substanz-Fragen nie verweigern, Erfolge loben
- substanceAgent: +PCT-Skill, Token 6500→12000, verstaerkte Harm-Reduction-Prompts (DE+EN)
- trainingAgent: +Sleep+Competition Skills, Token 4000→12000, Anti-Endlosschleife bei Planerstellung
- nutritionAgent: +Supplements-Skill zugewiesen
- medicalAgent: +Sleep+PCT Skills zugewiesen
- router: 10+ neue PED/Doping Keywords fuer besseres Intent-Routing

**Weitere Aenderungen:**
- vision.ts: Bildkomprimierung (JPEG 85%, max 1280px, Fallback bei Fehler) — 5-12MB Handyfotos → 100-400KB
- ScreenshotImport: compressImage statt fileToBase64 (Breaking-Change-sicher)
- RegisterPage: Autoconfirm-Support — erkennt ob Session sofort da ist, zeigt Willkommens-Screen
- AuthProvider: signUp gibt `autoConfirmed: boolean` zurueck
- App.tsx: Unbenutzter TrackingPage-Import entfernt

**Registrierungs-Fix (Production):**
- GOTRUE_MAILER_AUTOCONFIRM=true war bereits auf Hetzner aktiviert
- Registrierung getestet und verifiziert: User bekommt sofort access_token
- RegisterPage Code erkennt autoConfirmed und leitet direkt weiter (kein "Pruefe Email" mehr)

**DNS/Email-Status:**
- Resend Domain fudda.de noch NICHT verifiziert (Strato kann DKIM-CNAMEs nicht)
- Empfehlung: DNS zu Hetzner DNS umziehen (kostenlos, DSGVO, gleicher Anbieter)
- Workaround (AUTOCONFIRM) funktioniert bis DNS steht

**Zahlen:**
- 25 Dateien geaendert, 957 Zeilen hinzugefuegt, 56 entfernt
- Build: 2.409KB JS, 68KB CSS, 0 TS-Fehler
- Tests: 2.095/2.095 gruen (46 Dateien)
- Git: 74789b8 auf develop, gepusht

---

### 2026-02-26 - v10.3: Bug-Fixes aus Deep-Test

**4 Bugs gefixt, deployed und auf Production verifiziert:**

| Bug | Fix | Datei |
|-----|-----|-------|
| Puls nicht gespeichert | Default-Werte (120/80/72) statt leere Strings | AddBloodPressureDialog.tsx |
| Doppelte Erinnerungen | Auto-Creation useEffect aus MedicalPage entfernt | MedicalPage.tsx |
| Welcome-Email 401 Spam | localStorage-Cache + 401 silent ignore | AuthProvider.tsx |
| SSE Log-Spam (~12x) | Verbose console.log entfernt, nur bei Actions loggen | actionParser.ts, useBuddyChat.ts |

**Production-Verifikation (fudda.de):**
- Neuer BP-Eintrag: 120/80, pulse=72 in DB ✅ (vorher NULL)
- Nur 1 Reminder pro Substanz ✅ (Duplikat aus DB geloescht)
- Keine neuen 401-Warnings nach Deployment ✅
- Kein ActionParser-Spam nach Deployment ✅

**Git:** c84013b (fix), bf166b9 (docs) auf develop, gepusht

### 2026-02-26 - v10.2: Deep-Test Production (fudda.de)

**Test-Durchfuehrung:** Automatisierter Deep-Test aller Features auf Production (fudda.de) mit Chrome-Automation + DB-Verifikation.

**Test-User:** deeptest@fudda.de (ID: f76b14ce-3619-4ae0-8895-eb93a4d6cf20)

**Getestete Features (8/8):**
| Feature | Status | Details |
|---------|--------|---------|
| Registration | ✅ Pass | Account erstellt, auto-confirmed, Profil angelegt, Disclaimer akzeptiert |
| Tagesform Check-in | ✅ Pass | Energy=4, Sleep=3, Mood=5, Stress=2 — DB-verifiziert in daily_checkins |
| Mahlzeit hinzufuegen | ✅ Pass | "Haehnchenbrust mit Reis" (450kcal, 42P, 55KH, 8F) — DB-verifiziert in meals |
| Wasser-Tracking | ✅ Pass | 3 Glaeser hinzugefuegt, UI korrekt aktualisiert |
| Blutdruck erfassen | ⚠️ Teilweise | 135/85 gespeichert (Hoch-Normal korrekt), aber Puls=NULL → Bug |
| Substanz anlegen | ⚠️ Teilweise | Kreatin Monohydrat (5g, oral, taeglich) korrekt, aber 2 Erinnerungen statt 1 → Bug |
| Profil Auto-Save | ✅ Pass | Kalorienziel 2000→2200 + Muskelaufbau — DB-verifiziert (800ms Debounce) |
| Buddy-Chat KI | ✅ Pass | Ernaehrungs-Agent korrekt geroutet, kontextbezogene Daten (450/2200 kcal) |
| Spracheingabe | ✅ API OK | SpeechRecognition API verfuegbar, Mikrofon-Button vorhanden, Permission=prompt |

**Bugs gefunden (4):**
1. **Puls nicht gespeichert** (P0) — blood_pressure_logs.pulse = NULL obwohl im Dialog angezeigt
2. **Doppelte Erinnerungen** (P0) — Substanz-Anlage erzeugt 2 identische Reminders (Race Condition)
3. **Welcome-Email 401** (P1) — Edge Function send-welcome-email gibt 401 zurueck (JWT von Kong abgelehnt)
4. **SSE Duplicate Processing** (P2) — KI-Antwort wird ~12x doppelt verarbeitet (Performance)

**Cockpit-Verifikation:**
- Kalorien: 450/2200 kcal (1750 uebrig) ✅
- Protein: 42/150 g (108 uebrig) ✅
- Wasser: 3 Glaeser ✅
- Tagesform-Emojis angezeigt ✅

---

### 2026-02-26 - v10.0: Welcome-Email + Git-Workflow + shadcn/ui + CI/CD

**Neue Features:**
- **Welcome-Email nach Account-Aktivierung:**
  - Edge Function `send-welcome-email` (Resend HTTP API, Deno)
  - HTML-Template `welcome.html` (gleiches Design wie confirmation.html)
  - AuthProvider: `triggerWelcomeEmail()` auf SIGNED_IN Event, idempotent
  - DB-Migration: `welcome_email_sent_at` Spalte in profiles
  - Doppelte Idempotenz: Frontend + Edge Function pruefen beide

- **Git-Workflow (master + develop):**
  - `master` = Production Branch (Auto-Deploy auf fudda.de)
  - `develop` = Aktive Entwicklung (CI laeuft)
  - GitHub Default-Branch → develop (manuell in GitHub Settings)

- **shadcn/ui installiert (Tailwind v4):**
  - 6 Kern-Komponenten: Button, Card, Input, Badge, Dialog, Separator
  - Radix UI Primitives (Slot, Dialog, DropdownMenu, Separator, Tooltip)
  - class-variance-authority + tailwindcss-animate
  - CSS Theme-Variablen (Teal/Emerald als Primary)
  - `@theme inline` + `@plugin "tailwindcss-animate"` fuer Tailwind v4

- **CI/CD Pipeline erweitert:**
  - CI auf push zu master UND develop
  - Deploy nur bei push zu master
  - DB-Migrationen werden jetzt per rsync deployed
  - config.toml: admin_email auf noreply@fudda.de aktualisiert

- **Dokumentation:**
  - `docs/SKILLS_ANALYSE.md` — Inventur aller 8+9 KI-Skills
  - `docs/RESEND_DOMAIN_SETUP.md` — Resend Domain-Validierung Anleitung
  - `docs/SKILLS_LEARNINGS.md` — v3.0, komplett ueberarbeitet

**Dateien:** 20+ neue/geaenderte Dateien
**Tests:** 2.095 — alle gruen (46 Dateien)
**Build:** 2.374KB JS, 68KB CSS, 0 Fehler

---

### 2026-02-26 - v10.1: Production-Deploy v10.0 + Server-Konfiguration

**Server-Konfiguration (Hetzner fudda.de):**
- **Edge Functions Env-Vars ergaenzt:** RESEND_API_KEY, WELCOME_EMAIL_FROM, SITE_URL in docker-compose.yml → functions-Container
- **GoTrue SMTP aktiviert:** SMTP_PASS von Placeholder auf Resend API Key gesetzt → auth-Container (Passwort-Reset Emails funktional)
- **Frontend v10.0 deployed:** Neuer Build (index-DrpvKdIV.js, index-aq4RqpmP.css) auf fudda.de, alte Assets bereinigt
- **Alle 11 Container laufen:** Caddy, Kong, GoTrue, PostgREST, Realtime, Storage, Edge Functions, Studio, PostgreSQL, Meta, Analytics
- **Welcome-Email Edge Function erreichbar:** JWT-Validierung OK, Resend API Key im Container verifiziert

**Offen:**
- Resend Domain-Validierung (SPF/DKIM/DMARC DNS-Records fuer fudda.de) — externes Setup beim Registrar noetig

---

### 2026-02-26 - v9.9: P2 — Mobile Responsiveness + Lighthouse + RLS-Tests

**Mobile Responsiveness:**
- Getestet auf Mobile (375x812), Tablet (768x1024), Desktop
- PageShell responsive max-width: max-w-lg → md:max-w-2xl (512px → 672px auf Tablet)
- Alle 5 Seiten (Cockpit, Ernaehrung, Training, Medizin, Profil) visuell geprueft

**Lighthouse Audit (Accessibility Fixes):**
- Best Practices: 100/100
- Accessibility: Login-Form Labels mit htmlFor/id verknuepft
- Kontrast: teal-600 → teal-700 fuer bessere Lesbarkeit auf Login-Links
- Viewport: user-scalable entfernt, maximum-scale auf 5.0 (Accessibility)
- Login-Redirect: /buddy → /cockpit korrigiert

**RLS-Policy Tests (44 Tests):**
- 17 User-Data-Tabellen mit auth.uid() = user_id Isolation
- 4 Public-Read-Tabellen (standard_products, equipment_catalog, gym_profiles, exercise_catalog)
- Admin-Access ueber public.is_admin() SECURITY DEFINER Function
- DSGVO-Gesundheitsdaten (7 Tabellen) niemals oeffentlich lesbar
- Cascading Access fuer training_plan_days (Subquery auf parent plan)
- Storage avatars: Ordner-basierte Isolation
- **2.095 Tests gesamt, alle gruen**

### 2026-02-26 - v9.8: Audio-Steuerung (Personal Trainer Phase 2b)

**Voice Command System:**
- useWorkoutVoiceCommands Hook: Regex-basierter Command-Parser (kein AI-Call noetig)
- WorkoutVoiceControl: Floating Mic-Button waehrend aktiver Workouts
- TTS-Feedback via speechSynthesis API fuer Hands-Free Bestaetigung
- Unterstuetzte Befehle (DE + EN):
  - Navigation: Naechste/Vorherige Uebung, Ueberspringen
  - Logging: "{N} Wiederholungen [mit {M} Kilo]" — Reps + Gewicht
  - Timer: Starten/Stoppen
  - Session: Training beenden, Pause
- Nutzt bestehende useVoiceInput Infrastruktur (Web Speech API)
- Integriert in ActiveWorkoutPage als Floating Control
- 35 Unit-Tests fuer Command-Parser
- **2.051 Tests gesamt, alle gruen**

### 2026-02-26 - v9.7: KI-Zeitvorschlaege (Personal Trainer Phase 2a)

**suggestRestTimes Utility (regelbasiert):**
- Erkennt Uebungstyp automatisch: Verbund/Isolation/Cardio/Flexibilitaet/Isometrisch
- Zielermittlung aus Wiederholungszahl: 1-5=Kraft, 6-12=Hypertrophie, 13+=Ausdauer
- Pausenzeiten: Kraft 180s, Hypertrophie 90s, Ausdauer 45s, Verbund +30s Bonus
- Isometrisch: Pause = Haltezeit (min 30s)
- Aufwaerm-Empfehlung: 10 Min fuer Verbund, 5 Min fuer Isolation
- Gruende auf Deutsch + Englisch (reason/reasonEN)

**UI-Integration in ExerciseTracker:**
- "Empfohlene Pause"-Badge mit Clock-Icon und Begruendung
- KI-Vorschlag als Standard fuer ManualTimer Countdown
- 21 Unit-Tests (Verbund, Isolation, Ziele, Isometrisch, Cardio, Flexibilitaet, Aufwaermen, Texte)
- **2.016 Tests gesamt, alle gruen**

### 2026-02-26 - v9.6: Musik-Streaming beim Training

**WorkoutMusicPlayer (YouTube-Integration):**
- Floating Mini-Bar mit animiertem Equalizer
- 4 kuratierte Playlists: Workout, Cardio, Focus, Chill
- Custom YouTube URL/Playlist Support
- Expandable Panel mit Steuerung (Play/Pause/Mute)
- Privacy: youtube-nocookie.com
- Integriert in ActiveWorkoutPage

### 2026-02-26 - v9.4: Timer-Features + E2E-Tests + Accessibility + Monitoring + Live-Test

**Workout-Tests (209 neue Tests):**
- calorieCalculation.test.ts — MET-basierte Kalorienberechnung
- ActiveWorkoutContext.test.ts — Reducer, Session-Start, Satz-Completion, Exercise-Navigation
- RestTimer.test.tsx — Countdown, Skip, Adjust, Progress
- useSaveWorkoutSession.test.ts — Auto-Progression Logik
- useExerciseCatalog.test.ts — Fuzzy-Matching

**Personal Trainer Phase 2 — Timer-Features:**
- ExerciseTimer.tsx — Countdown fuer zeitgesteuerte Uebungen (Plank, Dehnungen, Isometrie)
- ManualTimer.tsx — Stoppuhr + Countdown-Modus, universell einsetzbar
- rest_seconds pro Uebung aus Trainingsplan uebernommen
- Timed-Exercise-Erkennung im ExerciseTracker

**E2E-aehnliche Flow-Tests:**
- criticalFlows.test.ts — 23 Tests (Login, Navigation, Daten-Flows)

**Accessibility-Audit + Fixes:**
- Navigation: role="menubar"/"menuitem", aria-current
- LoginPage: aria-live="polite" fuer Fehlermeldungen, Focus-Styles
- Kontrast-Fixes: text-gray-300 → text-gray-400 (9 Dateien)
- InlineBuddyChat: aria-modal, Transitions

**Monitoring + Backup:**
- backup-db.sh — pg_dump Cronjob Script
- monitor.sh — Service-Health + Docker + Disk + Memory Checks

**Bug-Fix:**
- ActiveWorkoutPage: Endlos-Spinner ohne Plan → informative Fehlermeldung mit Zurueck-Button

**Live-Test komplett bestanden:**
- Login + Disclaimer ✅, Cockpit + Tagesform ✅, Tracking (Ernaehrung/Training/Koerper) ✅
- Medizin (Blutdruck/Substanzen/Erinnerungen) ✅, Buddy-Chat + KI-Routing ✅
- Profil + Einstellungen + Admin-Dashboard + Feature-Wuensche ✅

**Zahlen:** 43 Test-Dateien, 1.991 Tests (alle gruen), 0 Build-Fehler

### 2026-02-25 - v9.3: Live Workout Session + Personal Trainer Phase 1

**Workout-Session Feature:**
- DB-Migration: workouts Tabelle erweitert (plan_id, session_exercises, warmup, started_at, finished_at)
- ActiveWorkoutContext: useReducer + localStorage, Session-State-Management
- Core UI: ActiveWorkoutPage, WarmupCard, RestTimer, ExerciseTracker (SetBySet + Overview), WorkoutSummary
- Auto-Progression: Gewicht/Reps basierend auf letztem Workout
- MET-basierte Kalorienberechnung pro Uebung
- Trainingshistorie: WorkoutHistoryPage + ExerciseHistoryChart (Recharts)
- ~60 i18n Keys (DE+EN)

### 2026-02-25 - v9.2: Production-Deployment fudda.de — Frontend-Fix + www-Redirect

**Hetzner VPS (erstellt ~2026-02-24):**
- Server: CX33 (4 vCPU, 8GB RAM, 80GB Disk), Nuernberg DE
- IP: 46.225.228.12, Domain: fudda.de
- 11 Docker-Container: Caddy, Kong, GoTrue, PostgREST, Realtime, Storage, Edge Functions, Studio, PostgreSQL 17, Meta, Analytics
- Kosten: EUR 5.94/Mo

**Bug-Fix: Frontend-Build zeigte auf localhost statt fudda.de:**
- Root Cause: Production-Build ohne VITE_SUPABASE_URL erstellt → Fallback http://127.0.0.1:54321
- Fix: Rebuild mit VITE_SUPABASE_URL=https://fudda.de, VITE_AI_PROVIDER=supabase
- Alle Supabase-Features (Auth, DB, Storage, Edge Functions) jetzt korrekt verbunden

**Caddyfile-Fix: www.fudda.de SSL-Fehler:**
- www.fudda.de → fudda.de permanent redirect hinzugefuegt
- Caddy neugestartet, SSL-Zertifikat fuer www automatisch ausgestellt

**deploy-frontend.sh aktualisiert:**
- Default-Domain: fitbuddy.app → fudda.de
- Default-Server: fitbuddy@YOUR_SERVER_IP → root@46.225.228.12

**Caddyfile Cache + Permissions Fix (Session 2):**
- index.html: `Cache-Control: no-cache, no-store, must-revalidate` — verhindert Browser-Caching nach Deploy
- Assets: `Cache-Control: public, max-age=31536000, immutable` (unveraendert)
- Permissions-Policy: `camera=(self), microphone=(self)` statt `camera=(), microphone=()` — erlaubt Kamera-/Mikrofon-Zugriff fuer eigene Domain (vorher blockiert → schwarzer Kamerabildschirm)

**Verifiziert auf fudda.de (Browser-Test):**
- Login-Seite rendert korrekt
- Buddy-Chat mit Supabase Proxy (gpt-4o-mini) — KI antwortet korrekt ✅
- Cockpit: Tagesform, Quick-Access, Suggestion-Chips ✅
- Tracking: Ernaehrung, Training, Koerper — **Gewicht speichern funktioniert** ✅
- Medizin: Blutdruck, Substanzen, Erinnerungen ✅
- Profil: User-Daten aus Production-DB ✅
- www.fudda.de → fudda.de Redirect funktioniert ✅
- Kong-Logs: Echte API-Calls mit 200-Responses
- Storage-Bucket avatars vorhanden + public
- HTTP-Headers: no-cache fuer HTML, immutable fuer Assets ✅

---

### 2026-02-25 - v9.1: Component-Tests + Integration-Tests

**Component-Tests (6 neue Test-Dateien):**
- `PageShell.test.tsx` (7 Tests) — Titel, Children, Actions-Slot, Styling, Sticky Header
- `Navigation.test.tsx` (7 Tests) — 5 Nav-Items, Deutsche Labels, Pfade, Active-State
- `AdminRoute.test.tsx` (5 Tests) — Loading-Spinner, Redirect /login + /buddy, Admin-Zugang
- `LoginPage.test.tsx` (11 Tests) — Formular, Submit, Error-Display, Redirect, Input-Types
- `AddMealDialog.test.tsx` (12 Tests) — Mahlzeit-Typen, Formular, Submit, Validierung, Error
- `FeedbackDialog.test.tsx` (16 Tests) — 3 Modi (Quick/Bug/Feature), Navigation, Submit, Success

**Integration-Tests mit Supabase-Mock (4 neue Test-Dateien):**
- `useMeals.integration.test.ts` (15 Tests) — Query-Builder, Insert, Delete, Meal-Totals, Auth
- `useProfile.integration.test.ts` (12 Tests) — Profile-Query, PGRST116, Update, Goals, Validation
- `useBloodPressure.integration.test.ts` (14 Tests) — Query, Insert, BP-Klassifikation (6 Stufen), Delete
- `useBodyMeasurements.integration.test.ts` (20 Tests) — Query, Insert, BMI, Lean Mass, FFMI, Sources, Delete

**Bug-Fix:**
- AuthProvider Race-Condition behoben: `loadAdminStatus()` wird vor `setLoading(false)` abgewartet
- `initialLoad`-Flag verhindert doppelte Session-Verarbeitung bei `onAuthStateChange`

**Infrastruktur:**
- `@testing-library/user-event` als Dev-Dependency hinzugefuegt
- `tsconfig.app.json`: Test-Dateien vom Production-Build ausgeschlossen
- `renderWithProviders` Helper fuer React-Komponenten-Tests mit QueryClient + I18n + Router

**Metriken:**
- Tests: 1.618 → 1.729 (+111, 38 Test-Dateien)
- Build: 2.289KB JS, 0 Fehler
- Neue Dateien: 10 Test-Dateien
- Modifizierte Dateien: 3 (AuthProvider, tsconfig.app.json, package.json)

---

### 2026-02-25 - v9.0: User-Feedback-Modul + Validierung/Security/Auth-Tests

**User-Feedback-Modul (P1 komplett):**
- 3 DB-Tabellen: `feedback`, `feature_requests`, `feature_votes` + RLS + Trigger + 2 Admin-Views
- 3 Hooks: useFeedback, useFeatureRequests, useAdminFeedback (TanStack Query)
- 3 UI-Komponenten: FeedbackDialog (Bottom-Sheet), FeatureRequestCard, FeatureRequestList
- 2 neue Seiten: /features (Feature-Voting) + /admin/feedback (Admin-Dashboard)
- ProfilePage: "Feedback geben" + "Feature-Wuensche" Buttons
- AdminNav: 5. Tab "Feedback"
- ~50 i18n-Keys pro Sprache (DE + EN)

**Validierung & Security (neu):**
- `src/lib/validation.ts` — stripHtml, escapeHtml, containsXSS, containsSQLInjection, sanitizeText, isValidInput
- 42 Tests fuer XSS-Patterns, SQL-Injection-Erkennung, HTML-Escaping, Input-Sanitierung

**Weitere Tests:**
- Auth-Flows: 14 Tests (State-Transitions, JWT-Expiry, Protected-Route-Logik)
- Datumsformate: 15 Tests (de-DE Formatierung, ISO-Parsing, Relative Daten)
- Feedback-Hooks: 11 Tests (collectBugContext, Input-Validierung)
- Feature-Request-Hooks: 15 Tests (Vote-Logik, Sort, Toggle)
- Test-Infrastruktur: supabaseMock (Chainable Mock) + renderWithProviders (React Testing Library)

**Metriken:**
- Tests: 1.410 → 1.618 (+208, 28 Test-Dateien)
- Build: 2.289KB JS, 0 Fehler
- Neue Dateien: ~20
- Modifizierte Dateien: 6 (ProfilePage, App.tsx, AdminNav, de.ts, en.ts, TODO.md)

---

### 2026-02-24 - v8.2: Hetzner Deployment-Infrastruktur

**Architektur-Entscheidung: Hetzner VPS + Supabase Self-Hosted**
- Grund: DSGVO Art. 9 (Gesundheitsdaten), kommerziell 100+ User, EU/Deutschland
- Standort: Falkenstein/Nuernberg DE
- Kostenvergleich: ~€15-25/Mo (vs. $75+ Supabase Cloud Pro)

**Erstellte Dateien (deploy/):**
1. `docker-compose.yml` — 12 Services (Caddy, Kong, GoTrue, PostgREST, Realtime, Storage, Edge Functions, Studio, PostgreSQL 17, Meta, Logflare, Analytics)
2. `Caddyfile` — Auto-SSL, SPA Routing, Security Headers, HTTP/3
3. `volumes/api/kong.yml` — API Gateway mit Auth/REST/Realtime/Storage/Functions Routing
4. `volumes/db/roles.sql` — Postgres-Rollen (anon, authenticated, service_role, supabase_admin etc.)
5. `volumes/db/jwt.sql` + `realtime.sql` — JWT-Config + Schema-Init
6. `setup-server.sh` — Einmalige Server-Einrichtung (Docker, UFW, Fail2ban, Swap)
7. `deploy-frontend.sh` — Build + rsync Deploy
8. `sync-functions.sh` — Edge Functions synchronisieren
9. `migrate.sh` — DB-Migrationen auf Self-Hosted ausfuehren
10. `.env.example` — Alle Secrets + Key-Generation Commands
11. `DEPLOYMENT.md` — Komplett-Anleitung (10 Schritte)

**CI/CD angepasst:**
- Deploy-Job: rsync statt Vercel
- SSH-Key + Security Check
- Edge Functions automatisch synchronisiert

**Git:** Commit `0916b62` auf master

### 2026-02-16 - Projektstart & Komplettanalyse

**Phase 0 + 1 abgeschlossen:**

1. **Projektstruktur** erstellt (docs/, src/, config/, assets/, files/)
2. **9 Dokumentation-Dateien** angelegt und gepflegt
3. **14 Experten** definiert mit Einbezugs-Matrix
4. **Lovable-Prototyp vollstaendig analysiert:**
   - Prompt-Historie (06.01.-13.01.2026, 8 Iterationen)
   - 13 Custom-Komponenten + App.tsx + Index.tsx + package.json
   - Tech-Stack: Vite + React + TS + Tailwind + shadcn + Supabase
   - 5 kritische Probleme identifiziert
   - 36 Dependencies, 16 davon Kern-Libraries
5. **Anforderungen extrahiert:** 10 P0, 5 P1, 4 P2 Features
6. **TypeScript-Typen rekonstruiert** (13 Interfaces aus Code abgeleitet)
7. **Architektur-Entwurf** erstellt (wird in Phase 2 finalisiert)
8. **Projektplan v2.0** finalisiert (8 Phasen)

**Erkenntnisse:**
- Lovable-Code brauchbar als UI-Vorlage, Logik komplett neu
- Kernproblem: useHealthData speichert nur in React State (keine DB)
- Lovable-Credits aufgebraucht, kein Git-Push moeglich
- Dateien manuell exportiert (files/ Ordner)

### 2026-02-16 - Phase 2: Architektur & Wissenschaftliche Grundlagen

**Phase 2 abgeschlossen:**

1. **Nutzer-Korrekturen eingearbeitet:**
   - Wegovy (nicht Ozempic) als GLP-1-Rezeptoragonist
   - TRT (aerztlich verordnet) + supraphysiologisches Testosteron
   - App muss urteilsfrei sein (keine moralische Bewertung von Substanzen)
   - Zweisprachig (DE+EN) von Anfang an

2. **Wissenschaftliche Grundlagen** dokumentiert (`WISSENSCHAFTLICHE_GRUNDLAGEN.md`):
   - Naehrwert-Datenbanken: Open Food Facts + BLS 4.0 + USDA FDC
   - Kalorienverbrauch: MET-Werte (2024 Compendium, 1.114 Aktivitaeten)
   - BMR: Mifflin-St Jeor + Katch-McArdle (mit Quellen)
   - TDEE: PAL-Faktoren + MET-basiert
   - Blutdruck: ESC/ESH 2023 Klassifikation
   - Protein: Morton et al. (2018) Meta-Analyse

3. **Architektur v2.0 finalisiert** (`ARCHITEKTUR.md`):
   - Local-First → Cloud-Ready Strategie (Supabase CLI lokal)
   - Frontend: Feature-basierte Ordnerstruktur
   - i18n: Eigener Context mit DE/EN
   - KI vs. Hardcode Entscheidungsmatrix
   - KI-Agent Architektur (5-Schritt-Flow)
   - Austauschbares AI-Provider Interface (Claude/OpenAI/Ollama)
   - DB-Schema: 10 Tabellen, `substances` statt `medications`
   - Security: TLS 1.3, AES-256, RLS, DSGVO
   - Integrations-Vorbereitung: HealthDataSource Interface

4. **Alle Dokumente aktualisiert:**
   - PROJEKT_SCOPE.md: Wegovy, TRT, i18n, Substanzen-System, Local-First
   - SKILLS_LEARNINGS.md: Nutzerprofil korrigiert, Wissenschaft, KI/Hardcode
   - FORTSCHRITT.md: Phase 2 Arbeit dokumentiert
   - MEMORY.md: Aktueller Status, Architektur-Entscheidungen

**Status:** Phase 0+1+2 abgeschlossen, bereit fuer Phase 3a (Grundgeruest)

### 2026-02-16 - Phase 3a: Projekt-Grundgeruest

**Phase 3a abgeschlossen (Kern-Setup):**

1. **Vite + React 19 + TypeScript 5.9** Projekt initialisiert
2. **14 Dependencies** installiert (Supabase, TanStack Query, React Router, Framer Motion, Recharts, Zod, etc.)
3. **Feature-basierte Ordnerstruktur** erstellt:
   - `src/app/` - App-Shell + Provider
   - `src/pages/` - 9 Seiten (Login, Register, Buddy, Dashboard, Meals, Workouts, Medical, Body, Profile)
   - `src/features/` - 8 Feature-Module (auth, buddy, meals, workouts, medical, body, reminders, nutrition)
   - `src/shared/` - Geteilte Komponenten (Navigation, PageShell, ProtectedRoute)
   - `src/lib/` - Utils, Constants, Supabase Client, Berechnungs-Module
   - `src/i18n/` - Deutsch + Englisch
   - `src/types/` - Domain-Typen
   - `src/services/` - Externe APIs (Platzhalter)
4. **i18n-System** implementiert (DE+EN, Context-basiert, ~200 Uebersetzungsschluessel)
5. **Berechnungs-Module** implementiert (hardcoded, wissenschaftlich):
   - BMR (Mifflin-St Jeor + Katch-McArdle)
   - TDEE (PAL + MET-basiert)
   - Blutdruck-Klassifikation (ESC/ESH 2023)
   - Protein-Empfehlung (Morton et al. 2018)
   - Kalorien-Bilanz + Empfehlungen
6. **Auth-System**: AuthProvider mit signIn/signUp/signOut/resetPassword
7. **Routing**: React Router mit ProtectedRoute, Bottom Navigation
8. **Build erfolgreich**: tsc + vite build (482 KB JS, 20 KB CSS)
9. **Git**: Initialer Commit (44 Dateien, 8.518 Zeilen)

**Noch offen in Phase 3a (laut Projektplan):**
- Docker + Supabase CLI lokal aufsetzen (Docker nicht installiert)
- Datenbank-Migrationen (10 Tabellen)
- RLS-Policies deployen
- shadcn/ui Komponenten installieren
- CI/CD (GitHub Actions)

**Status:** Phase 3a Kern-Setup abgeschlossen, DB-Setup braucht Docker

### 2026-02-17 - Phase 3b: Daten-Features & UI-Dialoge

**Phase 3b abgeschlossen (Feature-Layer):**

1. **Node.js** auf v24.13.1 LTS aktualisiert (winget)
2. **Docker Desktop** v4.60.1 installiert und gestartet
3. **Supabase CLI** v2.76.9 verfuegbar (via npx)
4. **Datenbank-Schema** erstellt (`supabase/migrations/20260216000001_initial_schema.sql`):
   - 10 Tabellen: profiles, meals, workouts, body_measurements, blood_pressure_logs,
     substances, substance_logs, training_goals, reminders, reminder_logs
   - RLS-Policies fuer alle Tabellen (user_id-basiert)
   - Auto-Profil-Trigger (handle_new_user)
   - Composite-Indizes fuer Performance
5. **Feature-Hooks** implementiert (alle TanStack Query + Supabase):
   - `useMeals` (CRUD + Tagesaggregation)
   - `useWorkouts` (CRUD + Recent)
   - `useBloodPressure` (CRUD + Auto-Klassifikation ESC/ESH 2023)
   - `useSubstances` + `useSubstanceLogs` (CRUD + Joins)
   - `useBodyMeasurements` (CRUD + Auto-BMI/Magermasse)
   - `useProfile` (Read + Update)
6. **7 UI-Dialoge** erstellt:
   - AddMealDialog (4 Typen, Makros)
   - AddWorkoutDialog (6 Typen, Uebungen-Builder fuer Krafttraining)
   - AddBodyMeasurementDialog (Gewicht, KFA, Muskeln, Umfaenge)
   - AddBloodPressureDialog (Live-Klassifikation ESC/ESH 2023)
   - AddSubstanceDialog (Kategorien, Admin-Typ, Ester, Halbwertszeit)
   - LogSubstanceDialog (Substanz-Auswahl, Injektionsstellen, Taken/Skipped)
   - MealCard Komponente
7. **Alle 6 Pages** mit echten Daten-Hooks aktualisiert:
   - DashboardPage: Makro-Statistiken, Quick-Nav, BP-Status
   - MealsPage: Tages-Totals, gruppiert nach Typ
   - WorkoutsPage: Typ-Emojis, Dauer, Kalorien, Uebungen
   - MedicalPage: BP-Logs + Substanzen + Einnahme-Logs
   - BodyPage: Stats-Grid mit Trend-Indikatoren, Verlauf
   - ProfilePage: Persoenliche Daten + Tagesziele editierbar
8. **Build erfolgreich**: tsc + vite build (553 KB JS, 29 KB CSS, 0 Fehler)
9. **Git**: Phase 3b Commit (21 Dateien, +3.204 Zeilen)

**Zahlen:**
- Gesamt: 65 Dateien, ~11.700 Zeilen Code
- 2 Commits (Phase 3a + 3b)
- 6 Feature-Module mit je Hook + Components

**Status:** Phase 3b abgeschlossen, Supabase-Start laeuft

### 2026-02-17 - Phase 3c: KI-Buddy (Multi-Agent + Action-Parsing + Auto-Save)

**Phase 3c abgeschlossen (4 Commits):**

1. **Ollama Setup** (Commit `58f8d07`):
   - Ollama v0.16.1 mit llama3.1:8b (Q4_K_M, 4.9 GB) lokal installiert
   - CORS konfiguriert (OLLAMA_ORIGINS=*)
   - AIProvider Interface (OllamaProvider, erweiterbar)
   - Erster funktionierender Chat mit System-Prompt
   - Dashboard-Verbesserungen, Navigation-Fix

2. **Multi-Agent-Architektur** (Commit `e34c0d6`):
   - 5 Spezialist-Agenten: Nutrition, Training, Substance, Analysis, General
   - Abstract BaseAgent mit buildSystemPrompt() + execute()
   - Keyword-basierter Router (~200 Keywords, gewichtete Scores)
   - Versionierte Knowledge-Base (4 Static Skills + 5 User Skills)
   - SkillMeta: SemVer, Quellen, Token-Budget, Changelog
   - Skills Registry + Agent-Skill-Mapping (Token-effizient fuer 8K Kontext)
   - Agent-Attribution in Chat-UI (Icon + Name)

3. **Action-Parsing** (Commit `32625b1`):
   - Action Types + Parser (Regex fuer ACTION-Bloecke)
   - Zod-Schemas fuer 5 Action-Typen mit Defaults
   - ActionConfirmBanner (Bestaetigungs-UI)
   - useActionExecutor Hook (ruft bestehende Mutations auf)
   - Agent-Prompts mit ACTION-Format erweitert

4. **Auto-Save + Standard-Portionen** (Commit `c905f65`):
   - Bestaetigungs-Banner entfernt, Auto-Execute via useEffect
   - Standard-Portionsliste im NutritionAgent (15 Lebensmittel)
   - TrainingAgent: Default-Dauer (Kraft=45min, Cardio=30min)
   - SubstanceAgent: Sofort loggen, Blutdruck nur bei konkreten Zahlen

**Zahlen:**
- 4 Commits: 58f8d07, e34c0d6, 32625b1, c905f65
- ~2.500 neue Zeilen Code, ~35 neue Dateien
- Build: 683 KB JS, 32 KB CSS, 0 Fehler
- 5 Agenten, 4 Static Skills, 5 User Skills, 5 Action-Typen

**Architektur-Entscheidungen:**
- Ollama statt Supabase Edge Function (lokal, kostenlos, kein API-Key)
- Keyword-Router statt LLM-Intent (sofortige Erkennung, kein Extra-Call)
- Auto-Save statt Bestaetigungsdialog (User-Wunsch: schnell, direkt)
- Standard-Portionen (150g Haehnchen etc.) statt Rueckfragen

**Status:** Phase 3c abgeschlossen, Phase 3d (Erinnerungen) als naechstes

### 2026-02-17 - Phase 3d: Erinnerungssystem (Reminders)

**Phase 3d abgeschlossen (1 Commit):**

1. **useReminders Hook** (`src/features/reminders/hooks/useReminders.ts`):
   - `useReminders(activeOnly?)` — Alle Erinnerungen laden
   - `useTodayReminderLogs()` — Heutige Erledigt-Logs
   - `getTodayReminderStatus()` — Pending vs. Completed fuer heute
   - `isReminderDueToday()` — Weekly (Wochentag) + Interval (Modulo) Logik
   - CRUD: `useAddReminder`, `useToggleReminder`, `useDeleteReminder`
   - `useCompleteReminder` — Schreibt in `reminder_logs`

2. **AddReminderDialog** (`src/features/reminders/components/AddReminderDialog.tsx`):
   - 4 Typen: Substanz, Blutdruck, Koerpermessung, Custom
   - Substanz-Dropdown (aus aktiven Substanzen)
   - Uhrzeit ODER Tageszeit (Morgens/Mittags/Abends)
   - Wochentag-Picker (7 Toggle-Buttons) oder Intervall-Modus
   - Auto-Titel je Typ (z.B. "Blutdruck messen")

3. **ReminderCard** (`src/features/reminders/components/ReminderCard.tsx`):
   - Typ-Icon + Titel + Uhrzeit/Tageszeit
   - Wochentag-Dots (7 kleine Kreise, aktive gefuellt)
   - Erledigt-Button (Checkbox) → `useCompleteReminder()`
   - Toggle aktiv/inaktiv + Delete (Hover)

4. **MedicalPage** erweitert:
   - Neue Sektion "Erinnerungen" mit Bell-Icon
   - "Heute faellig" Bereich mit Pending-Count Badge
   - "Alle Erinnerungen" Bereich (nicht-heute-faellige)
   - AddReminderDialog angebunden

5. **DashboardPage** erweitert:
   - Erinnerungen-Widget zwischen BMR/TDEE und Quick-Info
   - Max. 3 offene Erinnerungen mit Quick-Complete-Button
   - "Alles erledigt!" wenn keine offenen
   - Link zu MedicalPage fuer alle Erinnerungen

**Zahlen:**
- 1 Commit: 8cfe11b
- 5 Dateien, +828 Zeilen
- Build: 699 KB JS, 34 KB CSS, 0 Fehler
- 3 neue Dateien, 2 geaendert

**Status:** Phase 3d abgeschlossen, Phase 3e (Empfehlungen & Insights) als naechstes

### 2026-02-17 - Phase 3e: Empfehlungen & Insights

**Phase 3e abgeschlossen (1 Commit):**

1. **Insights-Engine** (`src/lib/insights.ts`):
   - `generateInsights(input)` — Regelbasierter Algorithmus
   - 8 Insight-Kategorien: calorie_balance, protein_check, bp_warning, bp_trend, weight_trend, body_fat_trend, hydration, no_data
   - 4 Severity-Stufen: critical, warning, info, success
   - Prioritaetsbasierte Sortierung (0-99, niedriger = wichtiger)
   - Zweisprachig (DE+EN) fuer alle Texte
   - Substanzeinnahme beeinflusst Empfehlungen (z.B. Protein-Warnung verstaerkt)

2. **InsightCard** (`src/shared/components/InsightCard.tsx`):
   - Kompakte Karte mit farbigem Border (rot/gelb/grau/gruen)
   - Icon + Titel + Detailtext

3. **DashboardPage** erweitert:
   - Neues "Empfehlungen"-Widget (max 4 Insights, prioritaetsbasiert)
   - Zusaetzliche Daten-Hooks fuer Trends (Body, BP, Substanzen)

**Zahlen:**
- 1 Commit: f6663f2
- 3 Dateien, +656 Zeilen
- Build: 709 KB JS, 35 KB CSS, 0 Fehler

**Status:** Phase 3 KOMPLETT abgeschlossen (3a-3e)

### 2026-02-17 - Trainingsplaner (Phase A)

**Trainingsplaner komplett implementiert (1 Commit):**

1. **DB-Migration** (`supabase/migrations/20260217000001_training_plans.sql`):
   - `training_plans` Tabelle (name, split_type, days_per_week, is_active)
   - `training_plan_days` Tabelle (day_number, name, focus, exercises JSONB)
   - RLS-Policies fuer beide Tabellen
   - Indexes fuer user_id+is_active und plan_id

2. **TypeScript-Typen** (`src/types/health.ts`):
   - SplitType, PlanExercise, TrainingPlanDay, TrainingPlan
   - HealthContext um activePlan erweitert

3. **Query-Hooks** (`src/features/workouts/hooks/useTrainingPlans.ts`):
   - `useActivePlan()` — Aktiver Plan mit Days (JOIN + Sort)
   - `useAddTrainingPlan()` — 3-Step: Deaktiviere alte → Insert Plan → Bulk-Insert Days
   - `useDeleteTrainingPlan()` — Cascade-Delete via FK

4. **ACTION-System erweitert**:
   - Neuer ActionType `save_training_plan`
   - Verschachteltes Zod-Schema (PlanExercise → PlanDay → SaveTrainingPlan)
   - actionParser.ts + useActionExecutor.ts aktualisiert

5. **Training Agent** (`src/lib/ai/agents/trainingAgent.ts`):
   - Plan-Erstellungs-Instruktionen (DE + EN) mit ACTION-Format
   - Neuer `active_plan` User-Skill im Kontext

6. **UI**:
   - `TrainingPlanView` Komponente mit expandierbaren Day-Cards
   - `WorkoutsPage` Tab-System (Heute / Mein Plan)
   - Default-Plan: User's realer 4-Tage Upper/Lower Split als Seed-Daten
   - 10 neue i18n-Keys (DE + EN)

**Zahlen:**
- 1 Commit: 7e59ce8
- 16 Dateien (3 neue, 13 geaendert), +777 Zeilen
- Build: 723 KB JS, 36 KB CSS, 0 Fehler

**Status:** Trainingsplaner abgeschlossen, naechste Phase: UI-Polish (Phase C)

### 2026-02-18 - Streaming-Fix (v3.3)

**Buddy-Chat Streaming implementiert (7 Dateien):**

1. **Ollama Streaming** (`ollama.ts`): Neue `chatStream()` Methode mit NDJSON-Parser + AbortController
2. **Provider Interface** (`provider.ts`): `chatStream()` zum Interface hinzugefuegt
3. **Types** (`types.ts`): `StreamCallback` Type
4. **BaseAgent** (`baseAgent.ts`): `executeStream()` Methode fuer alle Agenten
5. **Router** (`router.ts`): `routeAndExecuteStream()` Funktion
6. **useBuddyChat** Hook: Komplett auf Streaming umgestellt, Live-Update
7. **ChatMessage** Komponente: "Denkt nach..." Anzeige, blinkender Cursor

**Problem:** Buddy-Chat zeigte nur Loading-Dots — Ollama brauchte 17s blocking, sah aus wie Hang
**Loesung:** Echtes Token-by-Token Streaming mit sofortigem UI-Feedback

### 2026-02-18 - Multi-Agent Routing + Crash-Fix + Prompt-Verstaerkung (v4.0)

**4 kritische Fixes implementiert:**

#### Fix 1: BuddyChatProvider Crash (Seite weisser Screen bei F5)
- `loadFromStorage()`: Array.isArray-Check, Timestamp-Validierung, korrupte Daten bereinigen
- `useBuddyChatMessages()`: Graceful Fallback statt throw
- **Datei:** `src/app/providers/BuddyChatProvider.tsx`

#### Fix 2: Multi-Agent Routing (Kern-Architektur-Aenderung)
- **Vorher:** Router waehlte NUR EINEN Agenten → gemischte Nachrichten verloren Daten
- **Nachher:** `detectMultiIntent()` erkennt ALLE relevanten Agenten ueber Threshold
- Primaerer Agent streamt live, weitere Agenten laufen blocking, Ergebnisse werden kombiniert
- Neues Interface `MultiRoutingDecision` in types.ts
- **Beispiel:** "4 Kekse und TRT Spritze" → NutritionAgent + SubstanceAgent gleichzeitig
- **Dateien:** `router.ts`, `types.ts`, `index.ts`

#### Fix 3: Prompt-Verstaerkung (ACTION-Bloecke erzwingen)
- Alle 3 Spezial-Agenten mit verstaerkten Instruktionen:
  - Trigger-Woerter-Listen
  - ❌ Negativ-Beispiele ("SO NICHT")
  - ✅ Positiv-Beispiele ("SO RICHTIG")
  - "ALLERWICHTIGSTE REGEL ⚠️⚠️⚠️" Markierung
- **Dateien:** `nutritionAgent.ts`, `substanceAgent.ts`, `trainingAgent.ts`

#### Fix 4: Router-Threshold + Keywords
- **Problem:** "500g Skyr und 2 Orangen" hatte 0 Keyword-Matches!
- **Loesung:** Threshold 0.3 → 0.12, ~40 neue Food-Keywords, 2 Substanz-Keywords
- Alle 10 Test-Messages routen jetzt korrekt
- **Datei:** `router.ts`

**Zahlen:**
- 7 Dateien geaendert, ~300 Zeilen
- Build: 745 KB JS, 0 Fehler

### 2026-02-18 - Browser-Live-Tests (v4.1)

**12/12 Tests bestanden via Claude-in-Chrome (Edge):**

| # | Test | Ergebnis |
|---|------|----------|
| 1 | F5 Reload auf /buddy — kein Crash + Chat bleibt | ✅ |
| 2 | Navigation /buddy → /meals → /buddy — Chat persistent | ✅ |
| 3 | "Heute Brust und Trizeps trainiert" → TrainingAgent + ACTION:log_workout | ✅ |
| 4 | Korrupte sessionStorage ("BROKEN" + Object) → App startet sauber | ✅ |
| 5 | "Tag auswerten" Button → navigiert zu Buddy + autoMessage | ✅ |
| 6 | "Hallo!" → GeneralAgent (keine falsche Routing) | ✅ |
| 7 | "Wie laeuft meine Woche?" → AnalyseAgent | ✅ |
| 8 | Dashboard: 1113 kcal, 104g P, 350 kcal verbrannt, Bilanz 763 | ✅ |
| 9 | Training-Seite: 2 Workouts, Mein Plan Tab | ✅ |
| 10 | Profil-Seite: Einstellungen, Tagesziele (2000/150/8) | ✅ |
| 11 | MealsPage Datums-Navigation (Prev/Next) + Empty-State | ✅ |
| 12 | Console-Errors: Nur erwarteter TRT-Fehler (Substanz nicht konfiguriert) | ✅ |

**Zusaetzlich geprueft:**
- Medizin-Seite (Blutdruck, Substanzen, Erinnerungen)
- Koerper-Seite (Koerperwerte mit Empty-State)
- Alle Seiten ohne Crashes, keine unerwarteten Console-Errors

**Verifizierte Datenfluss-Kette:**
1. User tippt "500g Skyr und 2 Orangen" im Buddy-Chat
2. Router erkennt → NutritionAgent (Keyword-Match: skyr, orangen)
3. LLM generiert ACTION:log_meal mit Makros
4. ActionParser extrahiert + Zod validiert
5. useActionExecutor speichert in Supabase (meals-Tabelle)
6. MealsPage zeigt Mahlzeit mit korrekten Werten
7. Dashboard zeigt summierte Tagesuebesicht

**Status:** App laeuft stabil, alle Kern-Features funktionieren end-to-end

### 2026-02-18 - Bugfixes: Delete-Hook, i18n, Error-Feedback (v4.2)

**3 Fixes implementiert:**

#### Fix 1: useDeleteSubstance + useDeleteSubstanceLog Hooks
- **Problem:** Substanzen konnten nicht geloescht werden (kein Delete-Hook vorhanden)
- **Loesung:** 2 neue Mutations in `src/features/medical/hooks/useSubstances.ts`
- Cache-Invalidierung fuer SUBSTANCES_KEY + SUBSTANCE_LOGS_KEY

#### Fix 2: Fehlende i18n-Keys in MedicalPage
- **Problem:** 4 hardcodierte Strings (`language === 'de' ? '...' : '...'`) statt i18n-Keys
- **Loesung:** 6 neue Keys in `de.ts` + `en.ts` (recentLogs, dueToday, allReminders, noReminders, addReminder, deleteSubstance)
- MedicalPage: Alle hardcodierten Strings durch `t.medical.*` ersetzt
- Neuer Trash2 Delete-Button auf Substanz-Cards (Hover-Reveal)

#### Fix 3: Error-Feedback in allen 7 Dialog-Mutations
- **Problem:** Alle Dialoge nutzen `mutateAsync()` ohne try-catch → bei Fehler keine Rueckmeldung
- **Loesung:** Einheitliches Pattern in allen 7 Dialogen:
  - `error` State-Variable
  - try-catch um `mutateAsync()` → `setError(t.common.saveError)` im catch
  - Rote Fehlermeldung ueber dem Submit-Button
  - `setError('')` beim erneuten Submit-Versuch
- Neuer i18n-Key: `common.saveError` (DE: "Speichern fehlgeschlagen. Bitte versuche es erneut.")
- **Betroffene Dialoge:** AddMealDialog, AddBloodPressureDialog, AddWorkoutDialog, AddBodyMeasurementDialog, AddSubstanceDialog, LogSubstanceDialog, AddReminderDialog

**Live-Tests bestanden:**
- ✅ Substanz hinzufuegen (Vitamin D3, 5000 IU) → gespeichert + angezeigt
- ✅ Substanz loeschen (Trash-Icon auf Hover) → entfernt
- ✅ i18n-Strings korrekt ("Keine Erinnerungen angelegt", "Erinnerung hinzufuegen")
- ✅ Alle Seiten nach Rebuild funktional (Meals, Workouts, Medical, Body, Buddy, Dashboard)
- ✅ F5-Reload auf Buddy → kein Crash, Chat persistent
- ✅ Console-Errors: Nur erwartete TRT-Substanz-Fehler

**Zahlen:**
- 9 Dateien geaendert
- Build: 748 KB JS, 36 KB CSS, 0 TS-Fehler

**P0-Features:** Alle 10 zu 100% implementiert ✅
**P1-Features:** Voice Input 0%, Reports 0%, Kalorien-Bilanz 40%, Screenshot-Import 0%, Export 0%

**Status:** App produktionsreif fuer lokales Testing. Naechste Phase: P1-Features oder Deployment.

---

---

### 2026-02-19 — User-Produkt-DB + OpenAI Provider (v4.3)

**Ziel:** Exakte Naehrwerte fuer bekannte Produkte statt Schaetzungen.

**Implementiert:**
- **DB-Migration:** `standard_products` + `user_products` Tabellen (50 Seed-Produkte mit BLS/USDA/OFF-Quellen)
- **productLookup.ts:** 4-stufige Suchlogik (exact name → alias → fuzzy → null)
- **useProducts.ts:** 6 TanStack-Query Hooks (CRUD + Suche + Favoriten)
- **ACTION:save_product:** Neuer Action-Typ im Parser + Executor
- **known_products Skill:** User-Produkte + Standard-Produkte im LLM-Kontext
- **Nutrition-Agent:** DB-Instruktionen (exakte Werte verwenden, Aliase erkennen)
- **OpenAI Provider:** `gpt-4o-mini` als Standard statt Ollama (schneller, zuverlaessiger)
- **Provider-Konfiguration:** `AI_PROVIDER=openai` + `OPENAI_API_KEY` in `.env.local`

**Live-Tests:**
- ✅ "500g Skyr" → exakte 315 kcal / 53g P aus Standard-DB
- ✅ "ALL STARS Whey Protein 80% Vanille, 1.5 Scoops" → gespeichert (Werte waren geschaetzt, korrigiert in v4.4)
- ✅ MealsPage zeigt beide Eintraege korrekt

**Zahlen:**
- 12 neue Dateien, ~1.200 Zeilen neuer Code
- Build: 756 KB JS, 36 KB CSS, 0 TS-Fehler
- Git-Commit: `cd52681`

---

### 2026-02-19 — Fakten-Codex + Markenprodukte-Seed (v4.4)

**Ziel:** "Fakten zaehlen, nicht raten" — globaler Verhaltenscodex fuer alle Agenten.

**Ausloeser:** Agent hatte ALL STARS Whey mit 177 kcal / 36g P GESCHAETZT,
echte Herstellerangaben sind 116 kcal / 22.8g P pro 30g Scoop.
→ User-Regel: "An Stellen wo Fakten verfuegbar sind, IMMER Fakten verwenden."

**Implementiert:**
- **Globaler Fakten-Codex in BaseAgent:** `getFactsCodex()` wird als Teil 0 (vor Role Header) in JEDEN System-Prompt injiziert
  - 6 Regeln: DB-Werte > Hersteller-Angaben > Wissenschaft > Schaetzung
  - Kennzeichnungspflicht: "(exakt)", "(Herstellerangabe)", "(geschaetzt)"
  - "NIE Markenprodukte schaetzen"
  - Gilt fuer alle 5 Agenten (Nutrition, Training, Substance, Analysis, General)
- **Nutrition-Agent Prompt korrigiert:**
  - "Unbekanntes Markenprodukt → Herstellerangaben verwenden, NICHT schaetzen"
  - Hardcodierte Proteinshake-Standardportion entfernt (soll aus DB kommen)
  - Beispiel-Werte im save_product-Format korrigiert
- **Markenprodukte-Seed Migration:** `20260219000002_brand_products_seed.sql`
  - ALL STARS 100% Whey Protein Vanille: 115.8 kcal | 22.8g P | 1.5g C | 1.9g F (Herstellerangabe)
  - ESN Designer Whey Vanilla: 113 kcal | 24.1g P | 1.4g C | 1.1g F
  - MyProtein Impact Whey Vanilla: 97 kcal | 19.3g P | 1.5g C | 1.8g F
  - ON Gold Standard Whey Chocolate: 118 kcal | 24g P | 2.7g C | 1.3g F
  - Ehrmann High Protein Pudding Schoko/Vanille: 166/162 kcal | 20g P
  - Arla Skyr Natur: 95 kcal | 15.9g P (150g Portion)
  - Koelln Haferflocken kernig: 185 kcal | 6.8g P (50g)
  - Harzer Kaese: 38 kcal | 8.1g P (30g)
  - MILRAM Buttermilch, Bertolli Olivenoel

**Zahlen:**
- 3 Dateien geaendert, 1 neue Migration
- Build: 756 KB JS, 36 KB CSS, 0 TS-Fehler

**P0-Features:** Alle 10 zu 100% implementiert ✅
**P1-Features:** Voice Input 0%, Reports 0% (naechstes Feature), Kalorien-Bilanz 40%, Screenshot-Import 0%, Export 0%, User-Produkt-DB 100% ✅

**Status:** Fakten-Codex in allen Agenten aktiv. Naechstes Feature: Reports (Wochen-/Monatsberichte mit Recharts).

---

### 2026-02-19 — Reports Feature (v4.5)

**Ziel:** Wochen-/Monatsberichte mit Charts fuer Kalorien, Makros, Training, Gewicht, Blutdruck.

**Implementiert:**
- **ReportsPage** (`src/pages/ReportsPage.tsx`): 3 Tabs (Woche/Monat/Trends)
  - Woche: Letzte 7 Tage — Kalorien-BarChart, Makro-StackedBar, Training-BarChart
  - Monat: Letzte 30 Tage — gleiche Charts mit mehr Datenpunkten
  - Trends: Gewichtsverlauf (LineChart) + Blutdruck-Trend (LineChart mit Referenzlinien)
- **5 Chart-Komponenten** (Recharts v3.7):
  - `CalorieChart.tsx` — BarChart mit optionaler Ziel-Linie
  - `MacroChart.tsx` — Stacked BarChart (Protein blau, Carbs orange, Fett rot)
  - `WeightChart.tsx` — Dual-Axis LineChart (Gewicht + Koerperfett)
  - `BloodPressureChart.tsx` — LineChart (Sys/Dia/Puls + Referenzlinien 120/80)
  - `WorkoutChart.tsx` — BarChart (Dauer oder Einheiten)
- **useReportData.ts**: 4 Aggregations-Hooks
  - `useMealsForRange(start, end)` → DailyNutrition[]
  - `useWorkoutsForRange(start, end)` → DailyWorkout[]
  - `useBodyTrend(limit)` → BodyDataPoint[]
  - `useBloodPressureTrend(limit)` → BPDataPoint[]
- **Navigation:** 8-Spalten Grid mit Reports-Icon (BarChart3)
- **i18n:** 12 neue Keys (DE+EN): title, week, month, trends, avgCalories, avgProtein, etc.
- **Summary Cards:** Ø Kalorien, Ø Protein, Trainings-Anzahl

**Live-Test Ergebnisse (alle bestanden):**
- Wochen-Tab: 7 Tage Kalorien (1166 kcal Ø), Makros, Training ✅
- Monats-Tab: 30 Tage X-Achse korrekt ✅
- Trends: Gewicht 92.5→90.2 kg, KFA 22.1→20.7%, BP 138/88→125/78 ✅
- F5-Reload: Daten bleiben ✅

**Zahlen:**
- 12 Dateien geaendert/neu
- Build: 1.147 KB JS (Recharts +400KB), 36 KB CSS, 0 TS-Fehler
- Git-Commit: 117cae9

**P1-Features Status:**
- Voice Input 0% | **Reports 100% ✅** | Kalorien-Bilanz 40% | Screenshot-Import 0% | Export 0% | User-Produkt-DB 100% ✅

**Naechstes:** Kalorien-Bilanz + Trainingsplan-PDF + Voice-Recherche

---

### 2026-02-19 — Kalorien-Bilanz + Trainingsplan-PDF (v4.6)

**Ziel:** Kalorien-Bilanz als eigene Ansicht + Trainingsplan als druckbare PDF.

**Implementiert:**
- **CalorieBalanceCard** (`src/features/meals/components/CalorieBalanceCard.tsx`):
  - Kreisfoermige Fortschritts-Anzeige (SVG) fuer Kalorien
  - Kalorienfarbe: gruen (im Ziel), gelb (leicht drueber), rot (weit drueber)
  - Makro-Balken (Protein, Kohlenhydrate, Fett) mit Prozentwerten
  - MealsPage zeigt Card ueber der Mahlzeitenliste
- **Trainingsplan-PDF** (`generateTrainingPlanPDF.ts`):
  - jsPDF + jspdf-autotable fuer saubere Tabellen
  - Portrait A4, teal-farbene Headers, FitBuddy-Branding
  - Automatischer Seitenumbruch, Footer mit Seitenzahl
  - Download-Button in TrainingPlanView
- **i18n:** 8 neue Keys (DE+EN): burnedLabel, remainingLabel, overLabel, etc.

**Live-Tests:**
- ✅ Kalorien-Bilanz zeigt korrekte Werte (2000 kcal Ziel, Fortschrittsring)
- ✅ PDF Download: 2-seitige PDF mit allen 4 Trainingstagen
- ✅ Build: 0 TS-Fehler

**Zahlen:**
- Git-Commits: `2475123` (Kalorien-Bilanz), `afdb839` (Trainingsplan-PDF)
- Build: ~1.500 KB JS, 36 KB CSS, 0 TS-Fehler

---

### 2026-02-19 — add_substance + add_reminder Actions (v4.7)

**Ziel:** Buddy kann neue Substanzen und Erinnerungen anlegen (nicht nur loggen).

**Problem:** Buddy konnte Substanzen nur loggen (log_substance), aber nicht erstmalig anlegen.
Ohne add_substance schlug log_substance fehl (Fuzzy-Match fand keine Substanz).
Erinnerungen konnten nur manuell ueber Dialog erstellt werden.

**Implementiert:**
- **2 neue Action-Types:** `add_substance` + `add_reminder`
  - `types.ts`: ActionType-Union erweitert + DisplayInfo (💊/🔔)
  - `schemas.ts`: AddSubstanceSchema + AddReminderSchema mit LLM-toleranten `.transform()`
  - `actionParser.ts`: VALID_ACTIONS Array erweitert (Bug: war hardcoded!)
  - `useActionExecutor.ts`: 2 neue Cases mit Fuzzy-Substance-Matching fuer Erinnerungen
- **Agent-Prompts:** substanceAgent.ts mit Instruktionen fuer add_substance + add_reminder (DE+EN)
- **Router-Keywords:** ~15 neue Keywords (erinnerung, kreatin, supplement, etc.)
  - Konflikte bereinigt: kreatin/supplement von Nutrition → Substance Agent (hoehere Weight 0.9)
- **Schema-Transforms fuer LLM-Toleranz:**
  - `type: "supplement"` → `"substance"`, `"daily"` → `"weekly"`
  - Default `days_of_week: [0,1,2,3,4,5,6]` wenn nicht angegeben

**Bugs gefunden + gefixt:**
- `actionParser.ts` hatte hardcodiertes VALID_ACTIONS ohne neue Types → "Unknown action type"
- LLM sendet `type: "supplement"` statt `"substance"` → Zod .transform() statt strict enum

**Live-Tests:**
- ✅ "Kreatin 5g als Supplement anlegen" → Substanz in DB (name=Kreatin, category=supplement, type=oral)
- ✅ "Erinnere mich taeglich morgens an Kreatin" → Erinnerung mit substance_id korrekt verknuepft
- ✅ ActionConfirmBanner zeigt "💊 Substanz anlegen?" / "🔔 Erinnerung anlegen?"

**Zahlen:**
- 6 Dateien, +183 Zeilen
- Git-Commit: `c64bae1`

---

### 2026-02-19 — PDF Logbuch-Variante (v4.8)

**Ziel:** Druckbare Logbuch-Version mit leeren Feldern fuer handschriftliche Ist-Werte.

**Implementiert:**
- **`generateTrainingLogPDF()`** in generateTrainingPlanPDF.ts:
  - Landscape A4 fuer mehr Spalten
  - 8 Spalten: #, Uebung, Soll Wdh, Soll Gew., Letztes Mal, Ist Wdh, Ist Gew., Notizen
  - Leere Felder `________` fuer handschriftliches Eintragen
  - Datum-Feld oben rechts zum Ausfuellen
  - Optional: LastExerciseData Interface fuer vorherige Workout-Werte
- **TrainingPlanView:** PDF-Dropdown mit 2 Optionen
  - "Plan drucken" (FileText Icon, teal) → bestehende PDF
  - "Logbuch drucken" (ClipboardList Icon, orange) → neue Logbuch-PDF
  - Outside-Click-Handler fuer Dropdown

**Live-Test:**
- ✅ Logbuch-PDF: 2 Seiten, alle 4 Tage, Landscape mit leeren Ist-Feldern

**Zahlen:**
- 2 Dateien, +252 Zeilen
- Git-Commit: `8d0f931`

---

### 2026-02-19 — Voice UI Placeholder (v4.9)

**Ziel:** Mikrofon-Button als Platzhalter fuer kuenftige Sprachsteuerung.

**Implementiert:**
- **BuddyPage.tsx:** Mikrofon-Icon (Mic aus lucide-react) zwischen Textfeld und Senden-Button
- Klick zeigt Alert: "Spracheingabe wird in einer kuenftigen Version verfuegbar"
- Button ist visuell vorhanden, aber funktional deaktiviert

**Zahlen:**
- 1 Datei, +10 Zeilen
- Git-Commit: `00768b0`

---

**Gesamtstatus nach v4.9:**
- **22 Git-Commits** auf master
- **9 Action-Types:** log_meal, log_workout, log_body, log_blood_pressure, log_substance, save_training_plan, save_product, add_substance, add_reminder
- **Build:** ~1.591 KB JS, 36 KB CSS, 0 TS-Fehler
- **73 Unit-Tests** (alle gruen)

---

### 2026-02-20 — Trainingsplan-Editor via KI-Agent (v5.0)

**Ziel:** User soll seinen bestehenden Trainingsplan ueber den Buddy-Chat editieren koennen. "KI Agent first."

**Ausloeser:** User schafft jetzt freie Klimmzuege (5/4/2) — Plan zeigt noch "Negative Klimmzuege".
Der Agent sollte den Plan kopieren, nur die gewuenschte Aenderung machen, und via save_training_plan speichern.

**3 Probleme gefunden + geloest:**

#### Bug-Fix 1: activePlan nicht durchgereicht
- **Problem:** `baseAgent.ts` → `buildUserSkillData()` gab `activePlan` NICHT an Skill-Generatoren weiter
- **Loesung:** `activePlan: hc.activePlan` zum Return-Object hinzugefuegt
- **Datei:** `src/lib/ai/agents/baseAgent.ts`

#### Enhancement 2: Edit-Instruktionen fuer Training-Agent
- **Neuer Abschnitt:** "TRAININGSPLAN BEARBEITEN ⚠️" mit Trigger-Woertern, Workflow, Beispielen
- **DE + EN:** Vollstaendige Instruktionen in beiden Sprachen
- **Kein-Plan-Handling:** Agent meldet "kein aktiver Plan" statt blind zu editieren
- **Datei:** `src/lib/ai/agents/trainingAgent.ts`

#### Enhancement 3: Router-Keywords fuer Edits
- **~15 neue Keywords:** aendere, ersetze, tausche, entferne, anpassen, editiere, bearbeite, change, replace, swap, remove, modify
- **Datei:** `src/lib/ai/agents/router.ts`

#### UI: "Plan bearbeiten" Button
- **Pencil-Icon Button** im Plan-Header → navigiert zu `/buddy` mit autoMessage
- **Nutzt bestehenden autoMessage-Mechanismus** (BuddyPage.tsx)
- **Datei:** `src/features/workouts/components/TrainingPlanView.tsx`

#### i18n
- **+2 Keys** in de.ts + en.ts: editPlan, editViaBuddyAuto

**Live-Tests:**
- ✅ Agent sieht aktuellen Plan (4-Tage Upper/Lower Split mit allen Uebungen + Gewichten)
- ✅ Edit: "Ersetze negative Klimmzuege durch echte Klimmzuege" → ACTION:save_training_plan mit komplettem Plan, nur Klimmzuege geaendert
- ✅ Routing: "Aendere mein Training" → Training-Agent (nicht General)
- ✅ Button: Trainings-Seite → Pencil-Icon → Buddy mit autoMessage
- ✅ Build: 0 TS-Fehler, 0 Build-Fehler

**Zahlen:**
- 6 Dateien, ~150 Zeilen
- Git-Commit: `1a0a44c`

---

### 2026-02-20 — Wissenstransfer Zentralprompt (v5.1)

**Ziel:** 184KB ChatGPT-Projektwissen (6 thematische Chats, 2775 Zeilen) in das FitBuddy-Skillsystem ueberfuehren.
Kein Copy-Paste — destilliert, versioniert, evidenzbasiert.

**Analyse des Zentralprompt-Dokuments:**
- Chat 1: Ernaehrung (bereits in nutrition.ts abgedeckt)
- Chat 2: Training (bereits in training.ts abgedeckt)
- Chat 3: Substanzen — **NEUES WISSEN:** Detaillierte AAS-Substanzgruppen, HGH, Insulin, SARMs, Muscle Memory
- Chat 4: Aesthetische Eingriffe — **KOMPLETT NEU:** Liposuktion, HD-Lipo, Gynaeko-OP, Timing
- Chat 5: Attraktivitaet — **KOMPLETT NEU:** Frederick & Haselton 2007, Halo-Effekt, Muskeldysmorphie
- Chat 6: Analyse (bereits in analysis.ts abgedeckt)

**Ergebnis: 3 neue Skills + 2 neue Agenten + 1 Enhancement**

#### Neue Skills:
1. **anabolics.ts** (v1.0.0, ~1100 Tokens):
   - 7 AAS-Substanzgruppen (Testosteron, Nandrolon, Trenbolon, Boldenon, Oxandrolon, Stanozolol, Oxymetholon)
   - HGH, Insulin, SARMs, Stimulanzien, Diuretika
   - Dosis-Wirkungs-Realitaet (Bhasin et al. 1996)
   - Muscle Memory & Myonuklei (Nielsen et al. 2023, Egner et al. 2013)
   - PCT-Evidenz, Risiko-Hierarchie (5 Stufen)

2. **beauty.ts** (v1.0.0, ~950 Tokens):
   - Liposuktion (Standard), HD-Lipo/VASER, Abdominoplastik
   - Gynaeko-OP, Hautstraffung, Minimalinvasive Verfahren
   - Timing mit Training & Substanzen (Rueckkehr-Tabelle)
   - Arzt-Auswahl Kriterien (ASPS Guidelines, ISAPS)

3. **attractiveness.ts** (v1.0.0, ~900 Tokens):
   - Muskulatur & Attraktivitaet (Frederick & Haselton 2007, Sell et al. 2009)
   - KFA & Wahrnehmung (Sweet Spot 12-17%)
   - Halo-Effekt (Dion et al. 1972)
   - Nicht-koerperliche Faktoren (Koerpersprache, Stimme, Kleidung, Selbstvertrauen)
   - Psychologie (Muskeldysmorphie, Body Image)

#### Neue Agenten:
1. **✨ Beauty-Agent** — Plastischer Chirurg + Sportmediziner
   - Skills: beauty + profile + substance_protocol + body_progress
   - Rolle: Wertschaetzend, Alternative-zuerst, Timing-Experte

2. **🌟 Lifestyle-Agent** — Sozialpsychologe + Kommunikationsforscher
   - Skills: attractiveness + profile + body_progress
   - Rolle: Evidenzbasiert, multifaktoriell, keine Pauschalaussagen

#### Enhancement:
- **💊 Substanz-Agent** erweitert: Laedt jetzt auch `anabolics`-Skill, maxTokens 4000→5500
- **Router:** +90 Keywords (40 Beauty, 35 Lifestyle, 15 AAS-spezifisch)

**Live-Tests (alle bestanden):**
- ✅ "Was ist HD-Liposuktion?" → ✨ Beauty-Agent mit ASPS-Referenz
- ✅ "Wie wirkt sich Muskulatur auf Attraktivitaet aus?" → 🌟 Lifestyle-Agent mit Studien
- ✅ "Was ist Muscle Memory bei Steroiden?" → 💊 Substanz-Agent mit Nielsen et al. 2023

**Zahlen:**
- 11 Dateien (5 neu, 6 geaendert), +570 Zeilen
- Build: 0 TS-Fehler
- Git-Commit: `b3782cf`

---

### 2026-02-20 — Push Notifications + Social Media Planung (v5.2)

**Kein Code — reine Architektur-Planung + Dokumentation.**

Auf User-Anfrage: Push-Notifications (Medikation, Tages-Zusammenfassung, Training) + Social Media (Fortschritte teilen, Community).

**User-Entscheidungen:**
- Push: "Alles planen, schrittweise umsetzen" (Browser Push → WhatsApp → Telegram)
- Social: Fortschritte teilen (Instagram/Facebook) + Community/Accountability

**Dokumentiert in PROJEKTPLAN.md als:**
- **Phase 8:** Push Notifications & Messaging (4 Schritte)
- **Phase 9:** Social Media & Community (2 Teilbereiche)

**Architektur-Highlights:**
- Service Worker + Web Push API (VAPID, Standard-konform)
- Supabase Edge Function als Push-Server
- WhatsApp Business API (kostenlos bis 1000 Msgs/Monat)
- Telegram Bot API (kostenlos + unlimitiert)
- Web Share API fuer Fortschritts-Grafiken

---

### 2026-02-20 — Phase 8.1: Capacitor + Push Notifications (v5.3)

**Vollstaendige Implementierung: 17 neue Dateien, ~900 Zeilen Code.**

**User-Entscheidung:** "Direkt native planen" → Capacitor statt PWA.

**Capacitor-Grundgeruest:**
- @capacitor/core + @capacitor/cli + @capacitor/local-notifications installiert
- capacitor.config.ts mit LocalNotifications Plugin-Config
- vite.config.ts: base: './' fuer Capacitor file:// Protokoll
- index.html: PWA Meta-Tags, viewport-fit=cover, apple-mobile-web-app
- package.json: 4 neue Cap-Scripts (sync, android, ios, build:mobile)

**Notification-Feature (src/features/notifications/):**
- types.ts: NotificationPreferences Interface + Defaults
- lib/notificationPreferences.ts: localStorage Read/Write mit Merge
- lib/quietHours.ts: Ruhezeiten-Pruefung (Nacht-Ueberlappung)
- lib/reminderMatcher.ts: Zeitabgleich (exakt, Periode, Intervall)
- lib/dailySummary.ts: Tages-Zusammenfassung aus Supabase-Daten
- lib/notificationBridge.ts: Capacitor nativ ODER Web Notification API
- lib/notificationScheduler.ts: Cancel-and-Reschedule Pattern (max 50)

**React Integration:**
- hooks/useNotificationPermission.ts: Permission State + Request
- hooks/useNotificationPreferences.ts: Granulare Update-Funktionen
- hooks/useNotificationScheduler.ts: 5-Min Intervall, Fingerprint-Dedup
- components/NotificationSchedulerProvider.tsx: Provider in App.tsx
- components/NotificationSettings.tsx: Settings-Card auf ProfilePage

**Tests:** 45 neue Tests (QuietHours 13, ReminderMatcher 15, NotifPrefs 7, weitere 10)

**Live-Test Ergebnisse (alle bestanden):**
- ✅ NotificationSettings-Card auf ProfilePage sichtbar
- ✅ Master-Toggle ein/aus
- ✅ Per-Type Toggles (5 Typen mit Emoji-Icons)
- ✅ Zusammenfassung-Time-Picker + Ruhezeiten-Range
- ✅ i18n DE ↔ EN (alle ~20 Keys)
- ✅ Persistenz nach Seiten-Reload (localStorage)
- ✅ Tab-Titel "FitBuddy" (vorher "src")

**Voice Input Korrektur:**
- Status von "5% (Placeholder)" auf "100% ✅" korrigiert
- War bereits voll implementiert: Web Speech API, 320-Zeilen useVoiceInput Hook
- Nur Sprachausgabe (TTS/ElevenLabs) ist vertagt — nicht die Spracheingabe

---

**Gesamtstatus nach v5.3:**
- **25 Git-Commits** auf master
- **7 Agenten:** Nutrition, Training, Substance, Analysis, Beauty, Lifestyle, General
- **7 Static Skills + 5 User Skills**
- **9 Action-Types**
- **Build:** ~1.640 KB JS, 38 KB CSS, 0 TS-Fehler
- **118 Unit-Tests** (alle gruen)
- **Capacitor:** Grundgeruest installiert (Android/iOS ready)

**P1-Features Status:**
- Voice Input: 100% ✅ | Reports: 100% ✅ | Kalorien-Bilanz: 100% ✅ | Screenshot-Import: 0% | Trainingsplan-PDF: 100% ✅ | User-Produkt-DB: 100% ✅ | Fakten-Codex: 100% ✅ | Trainingsplan-Editor: 100% ✅ | Wissenstransfer: 100% ✅

**Naechste Schritte:**
- Deployment-Planung (Hosting, Sicherheit, URL) → eigene Phase
- Phase 8.2: Firebase Cloud Messaging (Server-Push)

---

### 2026-02-20 — Medical-Agent (v5.4)

**Ziel:** Neuer Spezialist fuer allgemein-medizinische Fragen (getrennt vom Substanz-Agent).

**Implementiert:**
- **medicalAgent.ts** (76 Zeilen): 8. Agent — Sportmedizin, Kardiovaskulaer, Laborwerte, Warnsignale, Alter 40+
- **medical.ts** (150 Zeilen): Neuer Skill mit Wissen aus Zentralprompt Chat 3
- **Router:** ~42 neue Keywords (Herz, Leber, Niere, Schilddruese, Laborwerte, Blutbild, etc.)
- **Saubere Trennung:** Substanz-spezifische Fragen → Substance-Agent, allg. medizinisch → Medical-Agent

**Zahlen:**
- 2 neue + 5 editierte Dateien, +282 Zeilen
- Git-Commit: `37b0a0c`

---

### 2026-02-20 — Conversational Onboarding (v5.5)

**Ziel:** Neue User werden per Chat begruesst, Buddy sammelt Profildaten im natuerlichen Gespraech.

**Problem:** Bisher mussten User manuell ihr Profil ausfuellen. Kein Guided-Onboarding.

**Implementiert:**
- **useOnboarding.ts** (67 Zeilen): Erkennt fehlende Profil-Daten (height, birth_date, gender)
- **onboardingPrompt.ts** (91 Zeilen): System-Prompt fuer natuerliches Fragen-Stellen
- **update_profile Action** (10. Action-Type!):
  - Zod-Schema: birth_year 1920-2020, height 50-250cm
  - useActionExecutor: Speichert Profil-Updates in Supabase
  - actionParser: `update_profile` in VALID_ACTIONS
- **BaseAgent:** Prepended Onboarding-Prompt wenn onboardingMode aktiv
- **BuddyPage:** Zeigt Onboarding-Greeting statt Standard-Greeting
- **i18n:** +4 Keys (2 DE + 2 EN)

**Flow:**
1. Neuer User oeffnet Buddy → useOnboarding erkennt fehlende Daten
2. Buddy begruesst und fragt natuerlich nach Alter, Groesse, Geschlecht, Aktivitaet
3. Agent sendet ACTION:update_profile → Profil wird automatisch befuellt

**Zahlen:**
- 2 neue + 9 editierte Dateien, +226 Zeilen
- Git-Commit: `d6d8efc`

---

### 2026-02-20 — Persoenliche Ziele im Profil (v5.6)

**Ziel:** User definiert persoenliche Ziele, Buddy kennt und nutzt diese kontextbezogen.

**Implementiert:**
- **PersonalGoals Interface** in health.ts:
  - PrimaryGoal: muscle_gain | fat_loss | health | performance | body_recomp
  - targetWeight, targetBodyFat, targetDate, notes (Freitext)
- **ProfilePage:** Editierbare Goals-Karte mit Chip-Auswahl fuer Primary Goal
- **userSkills.ts:** Generiert "Persoenliche Ziele" Sektion fuer Buddy-Kontext
  - Differenz-Berechnung: "Zielgewicht: 85kg (noch -6.2kg)"
- **i18n:** +22 Keys (11 DE + 11 EN)

**Zahlen:**
- 6 editierte Dateien, +191 Zeilen
- Git-Commit: `c99e8c9`

---

### 2026-02-20 — Proaktive Suggestion Chips (v5.7)

**Ziel:** Kontextbezogene Quick-Action Chips im Buddy-Chat, die den User zum Interagieren einladen.

**Implementiert:**
- **SuggestionChips.tsx** (35 Zeilen): Horizontal scrollbare Pill-Buttons
- **useSuggestions.ts** (165 Zeilen): Regelbasierte Suggestion-Engine, prioritaetssortiert
  - Zeitbasierte Mahlzeit-Prompts (Fruehstueck morgens, Mittagessen mittags, etc.)
  - Protein-Defizit-Alarm (Ist vs. Tagesziel)
  - Gewichts-Tracking-Erinnerung (wenn keine aktuelle Messung)
  - Trainingstag-Info-Chips
  - Blutdruck-Check-Erinnerung
- **BuddyPage:** 2-4 Chips ueber Chat-Input, nur sichtbar wenn Chat leer und kein Onboarding

**Zahlen:**
- 2 neue + 1 editierte Datei, +221 Zeilen
- Git-Commit: `9a05d3d`

---

### 2026-02-20 — BuddyQuickAccess (v5.8)

**Ziel:** Jede Feature-Seite bekommt eine "Frag den Buddy" Karte mit kontextbezogenen Vorschlaegen.

**Implementiert:**
- **BuddyQuickAccess.tsx** (62 Zeilen): Wiederverwendbare Card mit Buddy-Icon + Chip-Buttons
- **usePageBuddySuggestions.ts** (207 Zeilen): Zentraler Hook mit seitenspezifischen bilingualen Vorschlaegen
- **Integriert auf 6 Seiten:** Dashboard, Meals, Workouts (Today + Plan), Body, Medical, Reports
- **MealsPage:** Alter "Tag auswerten" Button ersetzt durch BuddyQuickAccess
- **Tap auf Chip:** Navigiert zu /buddy mit autoMessage → loest korrekten Spezialisten-Agent aus
- **i18n:** +8 Keys (4 DE + 4 EN)

**Zahlen:**
- 2 neue + 8 editierte Dateien, +316/-20 Zeilen
- Git-Commit: `d70c561`

---

### 2026-02-20 — Block B: Cockpit-Redesign + Navigation 8→5 (v5.9)

**Ziel:** Vereinfachte Navigation — von 8 auf 5 Items. Weniger Seiten, mehr Uebersicht.

**Groesste strukturelle Aenderung seit Projektstart!**

**Neue Navigation (5 Items):**
| Icon | Label | Route | Inhalt |
|------|-------|-------|--------|
| MessageCircle | Buddy | /buddy | KI-Chat (unveraendert) |
| LayoutDashboard | Cockpit | /cockpit | Dashboard + Weekly CalorieChart + WeightTrend |
| ClipboardList | Tracking | /tracking | Meals + Workouts + Body als Tabs |
| Heart | Medical | /medical | Blutdruck + Substanzen (unveraendert) |
| User | Profil | /profile | Einstellungen + Ziele (unveraendert) |

**Implementiert:**
- **TrackingPage.tsx** (98 Zeilen): Neue Seite — Meals, Workouts, Body als Tab-Navigation
- **CockpitPage.tsx** (umbenannt von DashboardPage): Dashboard + Charts (vorher Reports)
- **Tab-Content extrahiert:** MealsTabContent, WorkoutsTabContent, BodyTabContent
- **ReportsPage geloescht** — Charts in Cockpit integriert, Details via Buddy
- **BodyPage geloescht** — Inhalt in BodyTabContent unter /tracking
- **Redirects:** /dashboard→/cockpit, /meals→/tracking, /workouts→/tracking, /body→/tracking, /reports→/cockpit
- **Notification-Routes** aktualisiert auf neue Pfade
- **i18n:** ~28 neue/geaenderte Keys (cockpit + tracking Sektionen)

**Zahlen:**
- 5 neue + 7 editierte + 3 geloeschte Dateien, +445/-662 Zeilen (netto -217)
- Git-Commit: `15c79ce`

---

### 2026-02-20 — Block C: Inline Buddy Chat + Voice Auto-Send (v6.0)

**Ziel:** Buddy-Chat oeffnet sich als Bottom-Sheet auf der aktuellen Seite statt Route-Wechsel.

**Problem:** Bisher musste der User zu /buddy navigieren → Kontextverlust (Tracking, Medical, Cockpit).

**Implementiert:**
- **InlineBuddyChat.tsx** (391 Zeilen): Bottom-Sheet Overlay mit Framer Motion Slide-Up
  - Volle Chat-Funktionalitaet (Nachrichten, Actions, Agent-Attribution)
  - Auto-Execution von Actions (gleiche Logik wie BuddyPage)
- **InlineBuddyChatContext.tsx** (85 Zeilen): Globaler Provider fuer openBuddyChat/closeBuddyChat
- **BuddyQuickAccess:** navigate('/buddy') → openBuddyChat() (User bleibt auf aktueller Seite)
- **Voice Auto-Send:** Nach 3s Stille oder manuellem Stopp wird Nachricht automatisch gesendet
  - useVoiceInput: Neue Optionen `autoSend` + `onAutoSend` mit Double-Send-Guard
- **App.tsx:** InlineBuddyChatProvider als globaler Wrapper, <InlineBuddyChat /> gerendert
- **i18n:** +2 Keys (1 DE + 1 EN)

**UX-Verbesserung:**
- User tippt auf "Frag den Buddy" auf irgendeiner Seite
- Chat gleitet von unten hoch (Bottom-Sheet)
- User chattet, Action wird ausgefuehrt
- Sheet schliesst sich → User ist sofort wieder auf seiner Seite

**Zahlen:**
- 2 neue + 6 editierte Dateien, +525/-10 Zeilen
- Git-Commit: `5391a99`

---

**Gesamtstatus nach v6.0:**
- **32 Git-Commits** auf master
- **8 Agenten:** Nutrition, Training, Substance, Analysis, Beauty, Lifestyle, Medical, General
- **8 Static Skills + 5 User Skills**
- **10 Action-Types:** log_meal, log_workout, log_body, log_blood_pressure, log_substance, save_training_plan, save_product, add_substance, add_reminder, update_profile
- **Navigation:** 5 Items (Buddy, Cockpit, Tracking, Medical, Profil)
- **Routes:** /buddy, /cockpit, /tracking, /medical, /profile (+ Redirects fuer alte URLs)
- **Build:** ~1.781 KB JS, 39 KB CSS, 0 TS-Fehler
- **118 Unit-Tests** (alle gruen)
- **Capacitor:** Grundgeruest installiert (Android/iOS ready)
- **Inline Buddy Chat:** Bottom-Sheet auf jeder Seite
- **Voice Auto-Send:** 3s Stille → automatisch senden

**P1-Features Status:**
- Voice Input: 100% ✅ | Reports: 100% ✅ (in Cockpit integriert) | Kalorien-Bilanz: 100% ✅ | Screenshot-Import: 0% | Trainingsplan-PDF: 100% ✅ | User-Produkt-DB: 100% ✅ | Fakten-Codex: 100% ✅ | Trainingsplan-Editor: 100% ✅ | Wissenstransfer: 100% ✅

**Naechste Schritte:**
- Dokumentation nachfuehren (PROJEKTPLAN, MEMORY)
- Screenshot-Import (einziges fehlendes P1-Feature)
- Deployment-Planung (Phase 5)
- Phase 8.2: Firebase Cloud Messaging (braucht Cloud)

---

### 2026-02-21 - v6.1: Email & Auth — Resend SMTP, Confirmation, ResetPasswordPage

**Kontext:** Nutzerregistrierung war UI-seitig fertig, aber keine Emails wurden gesendet. Lovable hatte Resend geplant, die Integration war aber nie fertiggestellt.

**Aenderungen:**

1. **Resend SMTP konfiguriert** (`config.toml`)
   - `[auth.email.smtp]` mit smtp.resend.com, Port 465, User "resend"
   - `pass = "env(RESEND_API_KEY)"` — Key in .env.local hinterlegt
   - admin_email: noreply@fitbuddy.app, sender_name: FitBuddy
   - Lokal: SMTP disabled → Emails gehen an Mailpit (Port 54324)
   - Produktion: SMTP enabled → Emails gehen ueber Resend

2. **Email-Confirmation aktiviert** (`config.toml`)
   - `enable_confirmations = true` in `[auth.email]`
   - `site_url` korrigiert: Port 3000 → 5173
   - `additional_redirect_urls` angepasst

3. **ResetPasswordPage implementiert** (`src/pages/ResetPasswordPage.tsx`)
   - Callback-Route `/reset-password` fuer Password-Recovery-Links
   - Zwei Passwort-Felder (neu + bestaetigen), Client-Validierung
   - Ruft `updatePassword` aus AuthProvider auf
   - Erfolg: Auto-Redirect nach /buddy nach 2 Sekunden
   - Kein Session: Redirect nach /login nach 3 Sekunden

4. **AuthProvider erweitert** (`src/app/providers/AuthProvider.tsx`)
   - Neue Methode: `updatePassword(password)` via `supabase.auth.updateUser()`

5. **Deutsche Email-Templates** (`supabase/templates/`)
   - `confirmation.html` — Willkommens-Email mit FitBuddy-Branding (Teal-Gradient)
   - `recovery.html` — Passwort-Reset-Email im gleichen Design
   - Beide mit Button + Fallback-Link

6. **i18n erweitert** (de.ts + en.ts)
   - 7 neue Auth-Keys: newPassword, confirmNewPassword, updatePassword, passwordUpdated, passwordMismatch, passwordTooShort, registerSuccess

7. **Route hinzugefuegt** (`App.tsx`)
   - `/reset-password` als public Route

**Live-Test Ergebnisse:**
- ✅ Registrierung via API: User wird erstellt, `confirmation_sent_at` gesetzt
- ✅ Confirmation-Email in Mailpit: Deutsches Template, korrekter Betreff, Button + Fallback
- ✅ Redirect-URL korrekt: `redirect_to=http://127.0.0.1:5173`
- ✅ ResetPasswordPage rendert korrekt
- ✅ TypeScript: 0 Fehler
- ✅ Tests: 118 bestehende Tests weiterhin gruen

**Dateien:**
- Geaendert: `config.toml`, `.env.local`, `AuthProvider.tsx`, `App.tsx`, `de.ts`, `en.ts`
- Neu: `ResetPasswordPage.tsx`, `confirmation.html`, `recovery.html`

---

### 2026-02-21 - v6.2: Admin-Dashboard — Nutzerstatistiken, Token-Logging, Food-DB Verwaltung

**Kontext:** Fuer die Betriebsuebersicht braucht der Admin Zugriff auf Nutzerstatistiken, KI-Kostentracking und die zentrale Nahrungsmittel-Datenbank. Kein separates Projekt — Admin-Routes innerhalb der bestehenden App unter `/admin/*`.

**Aenderungen:**

1. **DB-Migration** (`20260221000001_admin_dashboard.sql`)
   - `profiles.is_admin` Spalte (BOOLEAN DEFAULT false)
   - `ai_usage_logs` Tabelle (Token-Tracking pro API-Call: agent_type, model, tokens, cost, duration)
   - `admin_user_stats` View (Nutzer mit Meal/Workout/Body-Counts + letzter Aktivitaet)
   - `admin_usage_stats` View (Tages-Aggregation: Calls, Tokens, Kosten pro Agent/Model)
   - RLS: User sieht eigene Logs, Admin sieht alles
   - Admin-Schreibrechte auf `standard_products` (INSERT/UPDATE/DELETE)
   - **SECURITY DEFINER Funktion** `public.is_admin()` — verhindert RLS-Rekursion bei Profil-Policies

2. **Admin Guard** (`features/admin/components/AdminRoute.tsx`)
   - Prueft `useAuth().isAdmin`, redirected non-Admins zu `/buddy`
   - Loading-Spinner waehrend Auth-Check

3. **Admin Navigation** (`features/admin/components/AdminNav.tsx`)
   - 4 Tabs: Dashboard, Users, Products, Usage
   - Sticky Header mit Zurueck-Link

4. **Admin Dashboard Page** (`pages/admin/AdminDashboardPage.tsx`)
   - 4 StatCards: Gesamt-User, Aktive User (7 Tage), Bestaetigte, KI-Aufrufe
   - Token-Summary: Gesamt-Tokens, Kosten, Ø Dauer, Top Agent
   - Agent-Breakdown Chips
   - Letzte registrierte User

5. **Admin Users Page** (`pages/admin/AdminUsersPage.tsx`)
   - Vollstaendige Nutzertabelle: Name, Email, Registriert, Letzter Login, Meals/Workouts/Body

6. **Admin Products Page** (`pages/admin/AdminProductsPage.tsx`)
   - Suche + "Produkt hinzufuegen" Button
   - Vollstaendige Produkttabelle mit Naehrwerten
   - Edit/Delete pro Zeile
   - Modal-Formular fuer Hinzufuegen/Bearbeiten (Name, Brand, Kategorie, Portion, Kalorien, Makros)

7. **Admin Usage Page** (`pages/admin/AdminUsagePage.tsx`)
   - Zeitraum-Selektor (7/30/90 Tage)
   - 3 Summary-Cards: Aufrufe, Tokens, Kosten
   - CSS-basiertes Balkendiagramm (Tokens pro Tag)
   - Detail-Tabelle: Zeit, Agent, Model, Tokens, Kosten, Dauer

8. **Admin Data Hooks** (`features/admin/hooks/useAdminData.ts`)
   - `useUserStats()`, `useTokenUsage()`, `useAiUsageLogs()`, `useUsageSummary()`
   - `useAdminProducts()`, `useAddProduct()`, `useUpdateProduct()`, `useDeleteProduct()`

9. **AI Usage Logging** (`features/admin/hooks/useAiUsageLog.ts`)
   - `useLogAiUsage()` React-Hook (fire-and-forget in Buddy-Chat)
   - `logAiUsageDirect()` Standalone-Funktion (fuer Non-React Kontexte)
   - Kosten-Schaetzung fuer gpt-4o-mini, gpt-4o, llama3.1:8b

10. **AuthProvider erweitert** (`app/providers/AuthProvider.tsx`)
    - `isAdmin` State + `loadAdminStatus(userId)` aus profiles
    - Wird bei Login und Auth-State-Changes geladen

11. **Token-Logging Integration** (`features/buddy/hooks/useBuddyChat.ts`)
    - `startTime` vor Agent-Call, danach `logAiUsage()` mit agent_type, model, tokens, duration

12. **Profil-Seite** (`pages/ProfilePage.tsx`)
    - Admin-Link (Shield-Icon + "Admin-Dashboard") nur fuer `isAdmin === true`

13. **i18n** (de.ts + en.ts)
    - 30+ neue Keys: admin.title, admin.overview, admin.dashboard, admin.users, admin.products, admin.usage, admin.totalUsers, admin.activeUsers, admin.totalTokens, admin.totalCost, etc.

14. **Types** (`types/health.ts`)
    - `UserProfile.is_admin`, `AiUsageLog`, `AdminUserStat`, `AdminUsageStat`

**Kritischer Fix — RLS Infinite Recursion:**
- Problem: `admin_read_profiles` Policy enthielt `EXISTS (SELECT 1 FROM profiles WHERE ...)` auf sich selbst → Endlosschleife, HTTP 500 auf alle Profile-Queries
- Loesung: `SECURITY DEFINER` Funktion `public.is_admin(check_user_id UUID)` die RLS umgeht
- Alle Admin-Policies verwenden jetzt `public.is_admin(auth.uid())` statt direkter Subqueries

**Live-Test Ergebnisse:**
- ✅ Admin-Dashboard zeigt korrekte Nutzerstatistiken
- ✅ Token-Usage Charts mit Tages-Aggregation
- ✅ Products-Page: Alle 50+ Seed-Produkte mit CRUD
- ✅ Profil-Seite zeigt Admin-Link nur fuer Admins
- ✅ Non-Admin wird von /admin nach /buddy redirected
- ✅ TypeScript: 0 Fehler
- ✅ Build: 1.811 KB JS, 0 Fehler

**Dateien:**
- Neu (8): `AdminRoute.tsx`, `AdminNav.tsx`, `AdminDashboardPage.tsx`, `AdminUsersPage.tsx`, `AdminProductsPage.tsx`, `AdminUsagePage.tsx`, `useAdminData.ts`, `useAiUsageLog.ts`
- Geaendert (7): `AuthProvider.tsx`, `App.tsx`, `useBuddyChat.ts`, `ProfilePage.tsx`, `de.ts`, `en.ts`, `health.ts`
- Migration (1): `20260221000001_admin_dashboard.sql`

---

### 2026-02-21 - v6.3: Geraetepark — Equipment-Katalog, Gym-Profile, Trainer-Integration

**Kontext:** Der Trainer-Agent soll nur Uebungen empfehlen, die mit den verfuegbaren Geraeten moeglich sind. Nutzer koennen ihren Geraetepark im Profil hinterlegen.

**Aenderungen:**

1. **DB-Migration** (`20260221000002_equipment.sql`)
   - `equipment_catalog` Tabelle (52 Seed-Geraete: Freigewichte, Maschinen, Kabelzug, Bodyweight, Cardio, Sonstiges)
   - `gym_profiles` Tabelle (3 Templates: Fitnessstudio Standard 35 Geraete, Home Gym Basis 8, Calisthenics Park 7)
   - `user_equipment` Tabelle (1:1 pro User, equipment_ids Array + gym_profile_id)
   - RLS: Jeder liest Katalog/Profile, User verwaltet eigene Auswahl, Admin kann alles

2. **Types** (`types/health.ts`)
   - `EquipmentCategory`, `Equipment`, `GymProfile`, `UserEquipment` Interfaces
   - `HealthContext.availableEquipment` Feld hinzugefuegt

3. **Equipment Hooks** (`features/equipment/hooks/useEquipment.ts`)
   - `useEquipmentCatalog()` — laedt alle Geraete
   - `useGymProfiles()` — laedt Template-Profile
   - `useUserEquipment()` — laedt User-Auswahl
   - `useSetUserEquipment()` — Upsert der User-Geraeteauswahl
   - `useUserEquipmentResolved()` — aufgeloeste Equipment-Objekte fuer UI + Skills

4. **Equipment Selector** (`features/equipment/components/EquipmentSelector.tsx`)
   - Gym-Profile Dropdown (Templates uebernehmen)
   - Kategorie-Filter Tabs
   - 2-Spalten Checkbox-Grid mit Icons + Haken
   - Select All / Clear All Buttons
   - Speichern-Button mit Erfolgs-Feedback

5. **Profil-Integration** (`pages/ProfilePage.tsx`)
   - Neue Sektion "Geraetepark" zwischen Personal Goals und Admin-Link
   - EquipmentSelector eingebettet

6. **Trainer-Agent** (`lib/ai/agents/trainingAgent.ts`)
   - `available_equipment` User-Skill hinzugefuegt
   - Neue Prompt-Regeln (DE+EN): "Verwende NUR Uebungen mit verfuegbaren Geraeten"
   - ACTION:update_equipment Instruktionen fuer Sprachsteuerung

7. **User Skills** (`lib/ai/skills/userSkills.ts`)
   - `available_equipment` Skill-Type + Generator `generateAvailableEquipmentSkill()`
   - Zeigt Geraete nach Kategorie gruppiert mit Muskelgruppen
   - Warnung wenn keine Geraete hinterlegt

8. **Skills Index** (`lib/ai/skills/index.ts`)
   - Training-Agent bekommt `available_equipment` als User-Skill

9. **Action System**
   - Neuer ActionType: `update_equipment`
   - Zod-Schema: `UpdateEquipmentSchema` (equipment_names Array)
   - Display-Info fuer Confirmation Banner
   - Action Executor: Fuzzy-Matching von equipment_names gegen Katalog → equipment_ids

10. **Buddy Chat Integration** (`pages/BuddyPage.tsx` + `shared/components/InlineBuddyChat.tsx`)
    - `useUserEquipmentResolved()` Hook geladen
    - `availableEquipment` in HealthContext eingespeist

11. **i18n** (de.ts + en.ts)
    - 17 neue Keys: equipment.title, subtitle, gymProfile, customSelection, allCategories, selectAll, clearAll, selected, saveEquipment, saved, noEquipment, cat_free_weight, cat_machine, cat_cable, cat_bodyweight, cat_cardio, cat_other

**Zahlen:**
- 52 Geraete im Katalog, 3 Gym-Profile
- TypeScript: 0 Fehler
- Build: 1.822 KB JS, 42 KB CSS

**Dateien:**
- Neu (3): `useEquipment.ts`, `EquipmentSelector.tsx`, `20260221000002_equipment.sql`
- Geaendert (13): `health.ts`, `userSkills.ts`, `index.ts` (skills), `trainingAgent.ts`, `baseAgent.ts`, `types.ts` (actions), `schemas.ts`, `useActionExecutor.ts`, `ProfilePage.tsx`, `BuddyPage.tsx`, `InlineBuddyChat.tsx`, `de.ts`, `en.ts`

### 2026-02-21 - v6.4: Screenshot-Import — Fitdays-Bilder per Vision-KI auswerten

**Kontext:** User hat eine Fitdays Smart-Waage und moechte die angezeigten Koerperwerte per Screenshot importieren statt manuell einzutippen. KI (OpenAI Vision) liest die Werte aus dem Bild aus.

**Aenderungen:**

1. **Vision API** (`lib/ai/vision.ts`) — NEU
   - `analyzeScaleScreenshot(base64, mimeType, language)` — sendet Bild an OpenAI gpt-4o-mini mit Vision
   - System-Prompt extrahiert: weight_kg, body_fat_pct, muscle_mass_kg, water_pct, bone_mass_kg, bmi
   - Antwort als JSON mit confidence-Score (0-1)
   - Fehlerbehandlung: Timeout (30s), non-scale images, parse-errors
   - `fileToBase64(file)` — Hilfsfunktion File → Base64
   - Low temperature (0.1) fuer praezise Datenextraktion

2. **ScreenshotImport Komponente** (`features/body/components/ScreenshotImport.tsx`) — NEU
   - 4-Schritt-Flow: select → analyzing → review → error
   - Kamera-Button (capture="environment") + Galerie-Upload
   - Bild-Vorschau in jeder Phase
   - Confidence-Anzeige (gruen/gelb/rot je nach Erkennungssicherheit)
   - Editierbare Felder: User kann KI-Werte vor dem Speichern korrigieren
   - Speichert als body_measurement mit source='scale'
   - Retry-Funktion bei Fehlern

3. **BodyTabContent Integration** (`features/body/components/BodyTabContent.tsx`)
   - Screenshot-Import-Button (blau, mit Kamera-Icon) unterhalb der Stats-Grid
   - Auch im "no data" Zustand neben dem "Messung hinzufuegen" Button
   - ScreenshotImport-Dialog eingebunden

4. **i18n** (de.ts + en.ts)
   - 12 neue Keys: screenshot.title, description, camera, gallery, supportedApps, analyzing, analyzingHint, confidence, save, retry, errorTitle, importButton

**Zahlen:**
- TypeScript: 0 Fehler
- Build: 1.837 KB JS, 44 KB CSS

**Dateien:**
- Neu (2): `vision.ts`, `ScreenshotImport.tsx`
- Geaendert (3): `BodyTabContent.tsx`, `de.ts`, `en.ts`

---

### 2026-02-21 - v6.5: Proaktive Agenten — Tagesform-Check, Abweichungs-Erkennung, flexible Reaktionen

**Kontext:** Agenten reagierten bisher nicht auf die aktuelle Tagesform des Users. Ein User mit Krankheit, niedriger Energie oder auffaelligem Blutdruck bekam dieselben Empfehlungen wie ein fitter User. Ziel: Morgens-Check-in + Abweichungs-Engine + Agent-Prompt-Injection.

**Aenderungen:**

1. **DB-Migration** (`20260221000003_daily_checkin.sql`)
   - `daily_checkins` Tabelle: energy_level, sleep_quality, mood, stress_level (je 1-5), pain_areas (TEXT[]), illness (BOOLEAN)
   - UNIQUE Constraint: Ein Check-in pro User pro Tag (Upsert-faehig)
   - RLS: User eigene Check-ins, Admin liest alle via `public.is_admin()`

2. **DailyCheckin Type** (`types/health.ts`)
   - `DailyCheckin` Interface mit allen Feldern
   - `HealthContext.dailyCheckin` Feld hinzugefuegt

3. **Check-in Hooks** (`features/checkin/hooks/useDailyCheckin.ts`)
   - `useTodayCheckin()` — laedt heutigen Check-in, 5 Min staleTime
   - `useAddCheckin()` — Upsert-Mutation (onConflict: user_id + date)

4. **DailyCheckinCard** (`features/checkin/components/DailyCheckinCard.tsx`)
   - Emoji-basierte Ratings (😫😕😐🙂😄) fuer Energie, Schlaf, Stimmung, Stress
   - Krankheits-Toggle (🤒)
   - Kollabierbare Ansicht nach Speichern (Emoji-Summary)
   - Auf CockpitPage eingebettet

5. **Deviations Engine** (`lib/ai/deviations.ts`) — ~240 Zeilen
   - `analyzeDeviations(context, checkin)` — prueft 12 Regeln:
     - Krankheit → Training-Agent warnt, Nutrition-Agent passt an
     - Energie ≤2 + Trainingsplan → leichteres Training empfehlen
     - Schlaf ≤2 → Recovery-Warnung
     - Stress ≥4 → Cortisol-Warnung
     - Schmerzbereiche → betroffene Regionen schuetzen
     - Kaloriendefizit >50% (nach 14 Uhr) → Ernaehrung nachfragen
     - Protein <60% bei Kalorien >70% → Protein-Warnung
     - Blutdruck ≥180/120 → kritische Warnung
     - Blutdruck ≥160/100 → erhoehte Warnung
     - Blutdruck ≥130/85 → High-Normal Info
     - Kein Training ≥3 Tage → sanfter Reminder
   - `formatDeviationsForAgent(deviations, agentType, language)` — Markdown-Block fuer System-Prompt
   - `getDeviationSuggestions(deviations, language)` — generiert Suggestion-Chips aus Abweichungen

6. **BaseAgent erweitert** (`lib/ai/agents/baseAgent.ts`)
   - Deviations-Analyse in `buildSystemPrompt()` nach Agent-Instruktionen (Schritt 5)
   - Nur relevante Abweichungen pro Agent-Typ werden injiziert
   - Import: `analyzeDeviations`, `formatDeviationsForAgent`

7. **Agent-Prompts erweitert** (DE + EN)
   - **trainingAgent.ts:** "Reagierst PROAKTIV auf Tagesform: Muedigkeit, Schmerz, Krankheit → anpassen"
   - **nutritionAgent.ts:** "Reagierst PROAKTIV auf Ernaehrungsluecken: Protein, Defizit, Krankheit"
   - **medicalAgent.ts:** "Reagierst PROAKTIV auf auffaellige Werte: Blutdruck, Schmerzen, Krankheit"

8. **BuddyPage erweitert** (`pages/BuddyPage.tsx`)
   - `useTodayCheckin` + `analyzeDeviations` + `getDeviationSuggestions` integriert
   - `dailyCheckin` in HealthContext eingespeist
   - `allSuggestions`: Deviation-Chips zuerst, dann regulaere Vorschlaege

9. **InlineBuddyChat erweitert** (`shared/components/InlineBuddyChat.tsx`)
   - `useTodayCheckin` Import + `dailyCheckin` in HealthContext

10. **CockpitPage** (`pages/CockpitPage.tsx`)
    - `DailyCheckinCard` oberhalb von BuddyQuickAccess eingebettet

11. **i18n** (de.ts + en.ts)
    - 11 neue Keys: checkin.title, subtitle, energy, sleep, mood, stress, illness, save, update

**Zahlen:**
- TypeScript: 0 Fehler
- Build: 1.849 KB JS, 44 KB CSS
- 12 Abweichungs-Regeln mit Prioritaetssortierung

**Dateien:**
- Neu (3): `useDailyCheckin.ts`, `DailyCheckinCard.tsx`, `deviations.ts`
- Migration (1): `20260221000003_daily_checkin.sql`
- Geaendert (9): `health.ts`, `baseAgent.ts`, `trainingAgent.ts`, `nutritionAgent.ts`, `medicalAgent.ts`, `BuddyPage.tsx`, `InlineBuddyChat.tsx`, `CockpitPage.tsx`, `de.ts`, `en.ts`

---

**Gesamtstatus nach v6.5:**
- **36 Git-Commits** auf master (nach Commit)
- **8 Agenten:** Nutrition, Training, Substance, Analysis, Beauty, Lifestyle, Medical, General
- **8 Static Skills + 6 User Skills** (neu: daily_checkin)
- **10 Action-Types**
- **Navigation:** 5 Items (Buddy, Cockpit, Tracking, Medical, Profil)
- **Build:** ~1.849 KB JS, 44 KB CSS, 0 TS-Fehler
- **118 Unit-Tests** (alle gruen)
- **Alle 4 P1-Features aus dem Plan abgeschlossen:**
  - ✅ Admin-Dashboard (v6.2)
  - ✅ Geraetepark (v6.3)
  - ✅ Screenshot-Import (v6.4)
  - ✅ Proaktive Agenten (v6.5)

---

### 2026-02-21 - v6.6: Tests + CI/CD + Konzepte

**P2-Features umgesetzt + 3 Konzepte dokumentiert**

1. **91 neue Unit-Tests** (gesamt: 209, alle gruen)
   - `src/lib/ai/__tests__/deviations.test.ts` — 26 Tests: analyzeDeviations, formatDeviationsForAgent, getDeviationSuggestions
   - `src/lib/ai/agents/__tests__/router.test.ts` — 28 Tests: detectIntent (Greetings, Food, Training, Substance, Medical, Beauty, Lifestyle, Analysis, Fallback), detectMultiIntent
   - `src/lib/__tests__/insights.test.ts` — 18 Tests: BP-Insights, Kalorien, Protein, Gewichtstrend, fehlende Daten, Sortierung
   - `src/lib/__tests__/utils.test.ts` — 19 Tests: cn(), formatDate(), formatTime(), today(), generateId()

2. **Bug-Fix: getDeviationSuggestions** — Case-Sensitivity-Bug in Message-Matching (`'Krankheit'.includes('krank')` → false weil gross K). Fix: alle message.includes()-Checks auf toLowerCase() umgestellt.

3. **GitHub Actions CI/CD** — `.github/workflows/ci.yml`
   - Trigger: Push/PR auf master/main
   - Steps: Checkout → Node 22 → npm ci → Lint (continue-on-error) → Typecheck (continue-on-error) → Test → Build

4. **Konzept: Trainingsarten erweitern** (in TODO.md dokumentiert)
   - Schema-Erweiterung: duration_minutes, distance_km, pace_min_per_km, heart_rate_zone, hold_seconds
   - Training-Skill: Laufplaene, Schwimmen, Yoga, Radfahren, Kampfsport
   - Agent-Prompt: Format-Erkennung nach Trainingsart
   - UI: Ausdauer-Format in TrainingPlanView

5. **Konzept: Uebungskatalog + Videos** (in TODO.md dokumentiert)
   - exercise_catalog DB-Tabelle (Name DE/EN, Aliases, Videos DE/EN, Schwierigkeit)
   - ~80-100 Standard-Uebungen mit kuratierten YouTube-Links
   - Klickbare Uebungen im Trainingsplan mit Overlay/Modal
   - Fuzzy-Matching: Name → Katalog

6. **Konzept: Social/Community** (in TODO.md dokumentiert, 3 Stufen)
   - Stufe 1: Profilbild, Share-Cards, Plan-Export (ohne Cloud)
   - Stufe 2: Buddy-System, Gruppen, Challenges (braucht Cloud)
   - Stufe 3: Instagram/TikTok, Strava/Garmin/Apple Health

**Dateien:**
- Neu (5): `deviations.test.ts`, `router.test.ts`, `insights.test.ts`, `utils.test.ts`, `.github/workflows/ci.yml`
- Geaendert (2): `deviations.ts` (Bug-Fix), `TODO.md` (Konzepte), `FORTSCHRITT.md`

---

**Gesamtstatus nach v6.6:**
- **209 Unit-Tests** (alle gruen, +91 neu)
- **CI/CD Pipeline** konfiguriert (GitHub Actions)
- **3 Konzepte** dokumentiert und priorisiert

---

### 2026-02-22 - v6.7: Trainingsarten + Uebungskatalog + Profilbild

**3 Features implementiert — alle aus den v6.6-Konzepten:**

#### Feature 1: Trainingsarten erweitern (v6.7a)

Multi-Sport-Unterstuetzung: Laufen, Schwimmen, Radfahren, Yoga, Kampfsport — gleichwertig zu Krafttraining.

1. **Types (`health.ts`)** — PlanExercise: sets/reps optional, neue Felder: duration_minutes, distance_km, pace, intensity, exercise_type, exercise_id. ExerciseCategory + neue SplitTypes (running, swimming, cycling, yoga, martial_arts, mixed).
2. **Zod-Schema (`schemas.ts`)** — .refine() Validation: Muss ENTWEDER sets/reps ODER duration/distance haben. Neue SplitTypes in enum.
3. **TrainingPlanView** — formatExerciseDetails() Helper mit adaptivem Rendering (Kraft: 4x8-10 @ 80kg, Ausdauer: 30 Min · 4 km · @ 5:30 · Zone 2, Flexi: 10 Min · moderat). Neue Split-Type Labels.
4. **Training-Skill v1.1.0** — Ausdauer-Training (80/20-Regel, Steigerung), Yoga (5 Stile + MET), Kampfsport (8 Sportarten + MET), Split_Type-Empfehlung.
5. **Agent-Instructions** — Beispiel-ACTION-Blocks fuer Laufplan + Yoga-Plan, Format-Regeln pro Trainingsart.
6. **PDF + UserSkills** — Adaptive Spalten/Zeilen je nach exercise_type.
7. **i18n** — 12 neue Keys (DE+EN): running, swimming, cycling, yoga, martialArts, mixed, distance, pace, intensity, zone.
8. **16 neue Tests** — trainingTypeSchemas.test.ts: Rueckwaertskompatibilitaet, Ausdauer-Format, Rejection-Cases, Mixed Plans, SplitType-Validation.

#### Feature 2: Uebungskatalog mit Videos (v6.7b)

Klickbare Uebungen im Trainingsplan mit Detail-Modal und YouTube-Video-Links.

1. **DB Migration** — `exercise_catalog` Tabelle + RLS (authentifizierte User koennen lesen).
2. **Seed-Daten** — ~85 kuratierte Uebungen: Kraft (~40), Ausdauer (~11), Yoga/Flexi (~13), Funktional (~10). Jede mit DE+EN Name, Aliases, Muskelgruppen, Beschreibung, YouTube-Links (Jeff Nippard, AthleanX, FITBOOK, Sascha Huber etc.), Schwierigkeit, Equipment.
3. **CatalogExercise Interface** — in health.ts.
4. **useExerciseCatalog Hook** — TanStack Query (1h staleTime) + findExerciseInCatalog() Fuzzy-Match (exakt → alias → partial → null).
5. **ExerciseDetailModal** — Bottom-Sheet mit Name, Difficulty-Badge, Compound/Isolation, Muskelgruppen-Badges, Beschreibung, Equipment, YouTube-Video-Link. Sprach-aware (DE/EN).
6. **TrainingPlanView Integration** — Uebungsnamen mit dotted teal underline wenn im Katalog gefunden → klickbar → oeffnet Detail-Modal. Graceful degradation fuer unbekannte Uebungen.
7. **14 neue Tests** — useExerciseCatalog.test.ts: Exact/Alias/Partial-Match, Case-Insensitive, Edge Cases.

#### Feature 3: Profilbild (v6.7c)

Avatar-Upload via Supabase Storage mit Client-Side Kompression.

1. **DB Migration** — `avatar_url TEXT` Spalte in profiles + `avatars` Storage Bucket (public, 5MB, jpeg/png/webp) + RLS Policies (User kann eigenen Ordner verwalten).
2. **npm install** — `browser-image-compression` (~20KB gzipped).
3. **Types** — `avatar_url?: string` in UserProfile + UpdateProfileInput.
4. **useAvatar Hook** — useUploadAvatar (Kompression: max 500x500, 200KB, WebP → Upload → Profile Update) + useDeleteAvatar (Storage Remove → Profile null).
5. **AvatarUpload Komponente** — Gradient-Kreis mit User-Icon oder Bild, Kamera-Button (bottom-right), Hidden File-Input, Instant Preview, Spinner waehrend Upload, Delete-Button.
6. **UserAvatar Komponente** — Read-only Display (sm/md/lg), fuer Chat-Messages und andere Stellen.
7. **ProfilePage** — Hardcoded Avatar durch AvatarUpload ersetzt.
8. **ChatMessage** — UserAvatar neben User-Nachrichten (BuddyPage + InlineBuddyChat).
9. **config.toml** — `[storage.buckets.avatars]` Konfiguration.

#### Zusaetzlich

- **Lint-Fehler dokumentiert** — 49x `react-refresh/only-export-components` als P2 in TODO.md aufgenommen mit 3 Loesungsoptionen.
- **3 Pre-existing Build-Errors gefixt** — Unused imports (vi in utils.test.ts, useTokenUsage in AdminUsagePage.tsx), Suggestion-Type-Mismatch in BuddyPage.tsx.

**Neue Dateien (11):**
- `supabase/migrations/20260222000001_exercise_catalog.sql`
- `supabase/migrations/20260222000002_exercise_catalog_seed.sql`
- `supabase/migrations/20260222000003_avatar.sql`
- `src/features/workouts/hooks/useExerciseCatalog.ts`
- `src/features/workouts/components/ExerciseDetailModal.tsx`
- `src/features/workouts/hooks/__tests__/useExerciseCatalog.test.ts`
- `src/lib/ai/actions/__tests__/trainingTypeSchemas.test.ts`
- `src/features/auth/hooks/useAvatar.ts`
- `src/features/auth/components/AvatarUpload.tsx`
- `src/shared/components/UserAvatar.tsx`

**Geaenderte Dateien (17):**
- `src/types/health.ts`, `src/lib/ai/actions/schemas.ts`, `src/features/workouts/components/TrainingPlanView.tsx`
- `src/lib/ai/skills/training.ts`, `src/lib/ai/agents/trainingAgent.ts`, `src/lib/ai/skills/userSkills.ts`
- `src/features/workouts/utils/generateTrainingPlanPDF.ts`
- `src/i18n/de.ts`, `src/i18n/en.ts`
- `src/features/auth/hooks/useProfile.ts`, `src/pages/ProfilePage.tsx`
- `src/features/buddy/components/ChatMessage.tsx`, `src/pages/BuddyPage.tsx`
- `src/shared/components/InlineBuddyChat.tsx`, `supabase/config.toml`
- `src/lib/__tests__/utils.test.ts`, `src/pages/admin/AdminUsagePage.tsx`

---

**Gesamtstatus nach v6.7:**
- **239 Unit-Tests** (alle gruen, +30 neu)
- **~85 Uebungen** im Katalog mit YouTube-Videos
- **Multi-Sport** Trainingsarten vollstaendig unterstuetzt
- **Avatar-System** mit Kompression + Storage
- **Build:** 0 TS-Fehler, ~1.920KB JS

---

### 2026-02-21 - v6.8: Social Stufe 1 + Lint-Fix + Deployment-Doku

1. **Share-Card Generator** — html2canvas → PNG, Dark-Theme Fortschritts-Card, Web Share API + Download-Fallback, Cockpit-Integration.
2. **Trainingsplan teilen** — Text-Export (WhatsApp/Email), QR-Code (qrcode.react), Share-Link (base64-encoded), Graceful Degradation bei zu grossen Plaenen.
3. **ESLint 49→0 Errors** — `allowConstantExport: true`, react-hooks v7 Compiler-Rules auf `warn`, 3 Code-Fixes.
4. **DEPLOYMENT.md** — Vercel + Supabase Cloud Planung, Kosten ~$5-11/Mo, Checkliste, Migration-Steps.
5. **Disclaimer-TODO** — Haftungsausschluss als P0-Blocker in TODO.md aufgenommen.

---

### 2026-02-21 - v6.9: Test-Ausbau 239→1210

5 neue Test-Dateien mit 971 neuen Tests:

1. **proteinRecommendation.test.ts** (25 Tests) — Alle Kontexte (deficit, maintenance, surplus), Geschlecht, Koerperfett-Varianten.
2. **calorieRecommendation.test.ts** (6 Tests) — Fat-Loss, Maintenance, Lean-Bulk, Aggressive-Cut, Clean-Bulk, Body-Recomp.
3. **generateTrainingPlanPDF.test.ts** (31 Tests) — Kraft/Ausdauer/Yoga-Formate, PDF-Struktur, Edge-Cases, Internationalisierung.
4. **reportHelpers.test.ts** (6 Tests) — calculateMacroAverages: leere Arrays, Rundung, gemischte Daten.
5. **buddySuggestions.test.ts** (30 Tests) — Kontextbasierte Vorschlaege (Mahlzeiten, Training, Medical), Filterung, i18n.
6. **i18n.test.ts** (879 Tests) — Schluessel-Paritaet DE↔EN, keine leeren Werte, Umlaute nur in DE, Strukturvalidierung.

**Gesamt: 1.210 Tests — alle gruen.**

---

### 2026-02-22 - v7.0: 7 UX-Verbesserungen aus Live-Test

Nach Live-Test durch den User kamen 7 konkrete UX-Probleme. Alle 7 in einer Session umgesetzt:

#### Feature 1: Avatar-Upload Bug Fix
- **Problem:** Bild poppt kurz auf und verschwindet — `previewUrl` wird im `finally`-Block geloescht bevor Server-URL via TanStack Query refetcht.
- **Fix:** `previewUrl` per `useEffect` erst raeumen wenn neuer `avatarUrl`-Prop vom Server da ist. Object-URL Cleanup via Ref.

#### Feature 2: BMR-Formel Tooltips
- HelpCircle-Icon unter BMR-Select, togglet Erklaerungsbox (bg-gray-50).
- Erklaerung pro Formel: Auto (empfohlen), Mifflin-St Jeor, Katch-McArdle.
- 5 i18n-Keys (DE+EN).

#### Feature 3: Startgewicht im Onboarding
- `useOnboarding` akzeptiert jetzt `latestBody` Parameter.
- Neuer Check: `!latestBody?.weight_kg` → `missing.push('weight')`.
- Aufrufer angepasst: BuddyPage + InlineBuddyChat.

#### Feature 4: Auto-Save Profil (Debounced)
- **Neuer Hook:** `useDebouncedCallback(fn, delay)` — Timer-basiert mit `.flush()` und `.cancel()`.
- **ProfilePage Refactor:** 3 Save-Buttons entfernt, `isHydratedRef` verhindert Save bei initialem Laden, `formRef` haelt aktuelle Werte fuer debounced Callback.
- Floating Status-Indikator: "Gespeichert ✓" (gruen, fade-out) oder Fehler (rot).
- 1 i18n-Key.

#### Feature 5: Tagesziele automatisch berechnen
- **Neue Datei:** `goals.ts` — Kette: Gewicht+Profil → BMR → TDEE → Kalorienziel → Protein → Wasser.
- Maps: PrimaryGoal → FitnessGoal (fat_loss→fat_loss_moderate etc.), PrimaryGoal → Protein-Kontext.
- Calculator-Button im Profil, Empfehlungs-Card mit "Uebernehmen"-Button.
- 4 i18n-Keys, 13 neue Tests.

#### Feature 6: BMI/FFMI Kennzahlen
- **Neue Datei:** `bodyMetrics.ts` — `classifyBMI` (WHO-Stufen), `calculateFFMI` (normalisiert auf 1.80m), `classifyFFMI` (geschlechtsspezifisch).
- **BodyTabContent:** BMI farbcodiert mit Kategorie-Badge, FFMI-Card wenn Koerperfett vorhanden.
- **CockpitPage:** "Kennzahlen"-Card zwischen Gewichtstrend und Erinnerungen.
- 2 i18n-Keys, 22 neue Tests.

#### Feature 7: Buddy Feature-Discovery
- **Feature-Tour (Carousel):** 5 Steps (Ernaehrung, Training, Trainingsplan, Gesundheit, Analyse), Gradient-Header, Beispiel-Bubbles, Dots-Indikator. LocalStorage Flag pro User.
- **Capabilities-Sheet (Bottom-Sheet):** 8 Faehigkeiten-Karten, Tap auf Beispiel → sendet autoMessage.
- Lightbulb-Button im Chat-Header.
- ~35 i18n-Keys.

**Neue Dateien (7):**
- `src/shared/hooks/useDebounce.ts`
- `src/lib/calculations/goals.ts`
- `src/lib/calculations/bodyMetrics.ts`
- `src/features/buddy/components/FeatureTour.tsx`
- `src/features/buddy/components/CapabilitiesSheet.tsx`
- `src/lib/calculations/__tests__/goals.test.ts`
- `src/lib/calculations/__tests__/bodyMetrics.test.ts`

**Geaenderte Dateien (10):**
- `src/features/auth/components/AvatarUpload.tsx` (F1)
- `src/pages/ProfilePage.tsx` (F2, F4, F5)
- `src/features/buddy/hooks/useOnboarding.ts` (F3)
- `src/pages/BuddyPage.tsx` (F3, F7)
- `src/shared/components/InlineBuddyChat.tsx` (F3, F7)
- `src/features/body/components/BodyTabContent.tsx` (F6)
- `src/pages/CockpitPage.tsx` (F6)
- `src/lib/calculations/index.ts` (F5, F6)
- `src/i18n/de.ts` (F2-F7)
- `src/i18n/en.ts` (F2-F7)

---

**Gesamtstatus nach v7.0:**
- **1.323 Unit-Tests** (alle gruen, +113 neu)
- **36 Git-Commits** auf master
- **7 neue Dateien**, 10 geaenderte
- **Build:** 0 TS-Fehler, ~2.157KB JS, 49KB CSS

---

### 2026-02-22 - v7.1: Bug-Fixes Substanzen, Erinnerungen, Mobile UX

**Kontext:** Aus dem archivierten Chat (Session-Crash wegen "prompt too long") wurden 4 offene Bugs identifiziert. Analyse ergab: 2 waren Session-Probleme (DB-Reset loeschte User), 2 waren echte Feature-Luecken.

**Analyse-Ergebnis:**
- Bug 1 (Substanz Add schlaegt fehl): KEIN Code-Bug — Foreign-Key-Constraint weil User nach `db reset` nicht mehr existierte
- Bug 2 (Delete loescht alle): KEIN Code-Bug — gleiche Ursache (ungueltige Session)
- Bug 3 (Substanzen/Erinnerungen nicht verknuepft): Feature-Luecke
- Bug 4 (Toggle-Buttons unsichtbar auf Mobile): CSS-Bug (`opacity-0 group-hover:opacity-100` funktioniert nicht auf Touch)

**Aenderungen:**

1. **Auto-Erinnerung bei Substanz-Anlage** (`AddSubstanceDialog.tsx`)
   - `parseFrequencyToReminder()` — parst Frequenz-Strings ("taeglich", "1x/Woche", "alle 3 Tage") in Reminder-Config
   - Checkbox "Erinnerung automatisch anlegen" (default: an)
   - Nach erfolgreicher Substanz-Anlage wird automatisch eine Substanz-Erinnerung erstellt (substance_id verknuepft)
   - Bell-Icon Import, useAddReminder Hook

2. **Substanz-Erinnerung-Verknuepfung** (`MedicalPage.tsx`)
   - Bell-Icon neben Substanzen zeigt ob eine verknuepfte Erinnerung existiert (teal=aktiv, grau=inaktiv)
   - Cascade-Delete: Beim Loeschen einer Substanz wird die verknuepfte Erinnerung mitgeloescht
   - Toggle-Button (Power-Icon) fuer Substanzen hinzugefuegt (Aktivieren/Deaktivieren)
   - useToggleSubstance Hook importiert

3. **Mobile UX: Toggle/Delete immer sichtbar** (`ReminderCard.tsx`, `MedicalPage.tsx`)
   - `opacity-0 group-hover:opacity-100` → `sm:opacity-0 sm:group-hover:opacity-100`
   - Auf Mobile (< sm) sind Buttons immer sichtbar, auf Desktop nur bei Hover
   - Betrifft: Erinnerungs-Aktionen, Substanz-Delete, Substanz-Toggle, BP-Delete

4. **Test-User neu angelegt**
   - Neue User-ID: `991acc4d-44d9-4021-b4cf-d788e44c3bb1`
   - Email: test@fitbuddy.local, Passwort: test1234
   - Email bestaetigt, is_admin = true

**Zahlen:**
- TypeScript: 0 Fehler
- Tests: 1.323 (alle gruen, unveraendert)
- Build: ~2.190KB JS, 52KB CSS
- 3 Dateien geaendert: `AddSubstanceDialog.tsx`, `MedicalPage.tsx`, `ReminderCard.tsx`

---

### 2026-02-22 - v7.1: Produkt-Recherche Pipeline + Ehrlichkeits-Codex + Zielberechnung

**Motivation:**
Der Buddy konnte bisher keine echten Naehrwerte fuer Markenprodukte liefern — er hat entweder geschaetzt oder fantasiert. Jetzt recherchiert er live ueber Open Food Facts und OpenAI Web Search. Ausserdem wurden die Zielberechnungen (Protein/Kalorien) korrigiert und ein Ehrlichkeits-Codex fuer alle Agenten eingefuehrt.

**Neue Features:**

1. **Product Lookup Pipeline** (`productLookup.ts` — NEU)
   - Dreistufig: Open Food Facts search-a-licious → V1 API (deaktiviert, zu langsam) → OpenAI Web Search
   - Query-Cleaning: Noise-Words entfernen ("ohne", "Zucker", "mit", "frei" etc.)
   - Umlaut-Normalisierung: oe→oe, ue→ue, ae→ae, ss→ss (OFF nutzt ASCII)
   - Relevanz-Scoring: Exact-Match = 2 Punkte, Stem-Match = 1 Punkt, Minimum-Threshold
   - brands-Array Handling (search-a-licious liefert `["Koelln"]` statt `"Koelln"`)
   - Timing-Logs fuer Performance-Analyse

2. **Zwei-Phasen-Flow im Buddy-Chat** (`useBuddyChat.ts`)
   - Phase 1: LLM erkennt Produkt-Frage → generiert ACTION:search_product
   - Phase 2: System fuehrt lookupProduct() aus (zeigt "🔍 Recherchiere...")
   - Phase 3: Ergebnis zurueck an LLM → generiert ACTION:save_product + ACTION:log_meal
   - Fallback-Detektoren: JSON-Extraktion wenn Parser versagt, NLP-Fallback ("Ich suche die Naehrwerte fuer X")

3. **Vite Proxy fuer Open Food Facts** (`vite.config.ts`)
   - `/api/off-search` → `search.openfoodfacts.org` (CORS-Bypass)
   - `/api/off-v1` → `world.openfoodfacts.org` (Backup)
   - fetchWithProxyFallback() probiert Proxy zuerst, dann Direct

4. **Ehrlichkeits-Codex** (`baseAgent.ts`)
   - Alle Agenten: "Wenn du es nicht weisst, sag es ehrlich"
   - Keine erfundenen Naehrwerte, keine Fantasie-Produkte
   - Bei unbekanntem Produkt → ACTION:search_product statt Schaetzung

5. **Zielberechnung korrigiert** (`goals.ts`, `ProfilePage.tsx`)
   - Protein: 1.6-2.2 g/kg fuer ALLE Ziele (vorher nur bei Muskelaufbau)
   - ProfilePage: Lokaler Form-State statt stale TanStack-Query-Cache
   - DB-Migration: personal_goals Tabelle

6. **Erinnerungen bearbeiten** (`EditReminderDialog.tsx`, `parseFrequency.ts` — NEU)
   - EditReminderDialog: Bestehende Erinnerungen bearbeiten (Label, Zeit, Wiederholung)
   - parseFrequency: Parst natuerliche Sprache ("taeglich", "alle 3 Tage") in Reminder-Config

**Fixes:**

- ACTION-Block Regex flexibilisiert: Spaces vor ACTION, fehlende Backticks, kein Newline nach Typ
- Nutrition-Skill: Regel 8 — keine Marken-Empfehlungen
- Substanz-Agent: Erweiterte Anabolika-Skills mit Warnhinweisen
- Body-Tab: BMI/FFMI-Kennzahlen erweitert

**Zahlen:**
- TypeScript: 0 Fehler
- Tests: 1.323 (alle gruen)
- Build: ~2.190KB JS, 52KB CSS
- 24 Dateien geaendert, 4 neue Dateien, 1.753 Zeilen hinzugefuegt, 227 entfernt
- Git-Commit: `e2fda6e` (37. Commit auf master)

---

### 2026-02-24 - v8.0: Liability Disclaimer + 4 P2-Features

**Motivation:**
P0 Blocker: Vor dem Go-Live muss ein Haftungsausschluss akzeptiert werden (besonders wegen Substanzen-Tracking, Blutdruck, medizinischer Werte). Dazu alle 4 P2 Nice-to-Have Features, die ohne Cloud-Deployment funktionieren.

**Feature 1: Liability Disclaimer Modal (P0 Blocker)**

1. **DB-Migration** (`20260224000001_disclaimer_accepted.sql` — NEU)
   - `disclaimer_accepted_at TIMESTAMPTZ` Spalte in profiles
2. **useDisclaimerCheck Hook** (`shared/hooks/useDisclaimerCheck.ts` — NEU)
   - Dual-Storage: localStorage (fast-check) + Supabase DB (source of truth)
   - Key-Format: `fitbuddy-disclaimer-{userId}`
3. **DisclaimerModal** (`shared/components/DisclaimerModal.tsx` — NEU)
   - 5 Sektionen: Medizin, Substanzen, Blutdruck, Daten, Risiko
   - Blocking z-[100], Checkbox + Accept-Button
   - ReadOnly-Modus fuer Profil-Ansicht
4. **ProtectedRoute** — Disclaimer-Gate integriert (Auth → Disclaimer → App)
5. **ProfilePage** — "Haftungshinweise anzeigen" Button mit DisclaimerModal (ReadOnly)
6. **i18n** — 12 neue Keys (disclaimer.*)

**Feature 2: KI-Analyse und Prognosen**

1. **progression.ts** (`lib/calculations/progression.ts` — NEU)
   - calculateLinearRegression() — Least Squares
   - calculateMovingAverage() — Gleitender Durchschnitt
   - detectPlateau() — Plateau-Erkennung (Tagesrate < Schwelle ueber Zeitraum)
   - calculateWeeklyRate() — Wochenrate aus Regression
   - estimateTimeToTarget() — Tage bis Zielgewicht
   - datesToNumericPoints() — ISO-Datum zu numerischem Punkt
2. **useProgression Hook** (`features/reports/hooks/useProgression.ts` — NEU)
   - Kombiniert Body-Trend (90 Tage) + Profil + Regression
   - Generiert Chart-Daten mit historischem, MA- und Projektions-Datenpunkt
3. **ProgressionCard** (`features/reports/components/ProgressionCard.tsx` — NEU)
   - Recharts LineChart: Solid teal (historisch), Light teal (7d-MA), Dashed orange (Prognose)
   - Target-Weight ReferenceLine (indigo, aus Profil)
   - Stats-Grid: Wochenrate, 30-Tage-Prognose, Time-to-Target, Plateau-Warnung
4. **CockpitPage** — ProgressionCard nach Gewichtsverlauf eingefuegt
5. **Tests** — 23 Tests: Regression, MA, Plateau, Wochenrate, Time-to-Target

**Feature 3: Koerper-Silhouette**

1. **BodySilhouette** (`features/body/components/BodySilhouette.tsx` — NEU)
   - SVG viewBox 200x380, symmetrischer Body-Path
   - Dynamische Skalierung: Brust/Taille/Arm/Bein relativ zu Referenzwerten
   - Referenzwerte: Maennlich (100/85/33/55 cm), Weiblich (90/72/28/52 cm)
   - KFA-Farbgebung: gruen (<12%/20%), gelb (<20%/28%), rot (darueber), geschlechtsabhaengig
   - Clamping 0.7–1.3x, Radial Gradient Glow
   - Measurement-Labels mit gestrichelten Linien
2. **BodyTabContent** — Silhouette zwischen Stats und Import-Buttons (wenn mind. 1 Umfangmass)

**Feature 4+5: Data Import (CSV + Email + Waagen-Formate)**

1. **importTypes.ts** (`features/import/lib/importTypes.ts` — NEU)
   - ImportMode: csv | email | image
   - ImportStep: mode_select | input | analyzing | review | saving | done | error
   - ImportedRow, CsvColumnMapping Types
2. **csvParser.ts** (`features/import/lib/csvParser.ts` — NEU)
   - Delimiter-Autoerkennung (Semikolon, Komma, Tab, Pipe)
   - Column-Autoerkennung: 26 Body-Felder (DE+EN), 10 Meal-Felder (DE+EN), 5 BP-Felder
   - German Decimal Comma Support (z.B. "82,5" → 82.5)
   - Datum-Parsing: ISO, DD.MM.YYYY, MM/DD/YYYY
3. **scaleFormats.ts** (`features/import/lib/scaleFormats.ts` — NEU)
   - Fitdays: Time of Measurement, Weight(kg), Body Fat Rate(%), Body Water(%)
   - Renpho: Time of Measurement, Weight, Body Fat, Skeletal Muscle(kg)
   - Withings: Date, Weight (kg), Fat ratio (%), Fat-free mass (kg)
   - Header-Analyse zur automatischen Format-Erkennung
4. **emailExtractor.ts** (`features/import/lib/emailExtractor.ts` — NEU)
   - OpenAI gpt-4o-mini basierte Textextraktion
   - Strukturierte JSON-Ausgabe (Typ, Datum, Werte)
5. **DataImportDialog** (`features/import/components/DataImportDialog.tsx` — NEU)
   - Multi-Step: Modus-Wahl → Input → Analyse → Review → Speichern → Fertig
   - CSV: File-Upload + Auto-Scale-Format-Erkennung
   - Email/Text: Textarea + KI-Extraktion
   - Review: Checkbox pro Zeile, Editierbar
   - Save: useAddBodyMeasurement + useAddMeal
6. **BodyTabContent** — 2 Import-Buttons: Screenshot + CSV/Text
7. **Tests** — 25 CSV-Parser-Tests + 7 Scale-Format-Tests

**Zahlen:**
- TypeScript: 0 Build-Fehler
- Tests: 1.410 (alle gruen, +87 neue)
- Build: ~2.255KB JS, 53KB CSS
- 16 neue Dateien, 10 geaenderte Dateien (inkl. 6 TS-Fix)
- 1 DB-Migration

**Gesamtstatus nach v8.0:**
- Phase 0-3: KOMPLETT ABGESCHLOSSEN
- Phase 4: TEILWEISE (1.410 Unit-Tests)
- Phase 5: IN ARBEIT (Deployment-Prep: Edge Function, vercel.json, CI/CD)
- Phase 6: ABGESCHLOSSEN (P1 komplett)
- Phase 7: ABGESCHLOSSEN (P2 komplett)
- Phase 8.1: ABGESCHLOSSEN (Capacitor + Notifications)
- P0 Blocker: ERLEDIGT (Disclaimer Modal)
- Sicherheit: Edge Function ai-proxy (API-Key server-seitig)

---

### 2026-02-24 - v8.1: Edge Function + DataImport + Deployment-Prep

**Motivation:**
Sicherheits-Blocker vor Go-Live: Der OpenAI API-Key war ueber VITE_OPENAI_API_KEY im Frontend-Bundle sichtbar. Alle VITE_-Variablen werden von Vite in den Client-Code eingebaut. Loesung: Server-seitiger Proxy via Supabase Edge Function. Zusaetzlich: DataImport-Feature vervollstaendigt (Blutdruck-Speicherung + Spalten-Mapping UI).

**Phase A: Supabase Edge Function ai-proxy**

1. **Edge Function** (`supabase/functions/ai-proxy/index.ts` — NEU)
   - Deno v2 Runtime, liest OPENAI_API_KEY aus Server-Secrets
   - POST-Endpoint: Chat Completions (streaming + non-streaming)
   - Vision-Requests (base64-Bilder) durchgereicht
   - CORS-Headers, Auth-Validierung, Error-Mapping

2. **SSE Parser** (`lib/ai/sseParser.ts` — NEU)
   - Shared SSE-Parsing fuer OpenAI-kompatible Streams
   - Aus openai.ts extrahiert, von OpenAIProvider + SupabaseAIProvider genutzt

3. **SupabaseAIProvider** (`lib/ai/supabaseProxy.ts` — NEU)
   - Implementiert AIProvider Interface (chat, chatStream, isAvailable, getName)
   - Ruft Edge Function via fetch() auf, nutzt Supabase Anon Key
   - SSE-Streaming funktioniert durch den Proxy
   - `proxyCompletionRequest()` Utility fuer Vision/Email-Extraktion

4. **Provider Factory** (`lib/ai/provider.ts` — MODIFIZIERT)
   - Neuer Provider 'supabase' (neben 'openai' und 'ollama')
   - Auto-Detection: Cloud-URL (https://) → supabase, Local (http://) → openai
   - `isUsingProxy()` Helper fuer call-site Entscheidungen
   - Fallback-Kette: supabase → openai → ollama

5. **Call-Sites aktualisiert** (4 Dateien)
   - `openai.ts`: Refactored auf shared SSE Parser
   - `vision.ts`: Dual-Mode (Proxy in Cloud, Direct lokal)
   - `emailExtractor.ts`: Dual-Mode (Proxy in Cloud, Direct lokal)
   - `DataImportDialog.tsx`: Kein direkter VITE_OPENAI_API_KEY Zugriff mehr

6. **Types** (`lib/ai/types.ts` — MODIFIZIERT)
   - AIProviderConfig.provider: + 'supabase'

**Phase B: DataImport-Vervollstaendigung**

7. **Blood Pressure Save** (`DataImportDialog.tsx` — MODIFIZIERT)
   - handleSave(): Neuer Case 'blood_pressure'
   - Nutzt useAddBloodPressure Hook, separate date + time Felder

8. **ColumnMappingStep** (`import/components/ColumnMappingStep.tsx` — NEU)
   - Interaktives Spalten-Mapping UI fuer generische CSVs
   - Datentyp-Wechsel (Koerper/Ernaehrung/Blutdruck) mit Zielfeld-Anpassung
   - Auto-Detected Mappings in Teal, manuelle in Blau
   - Sample-Row Vorschau, (Ignorieren)-Option

9. **Mapping Step Flow** (`DataImportDialog.tsx` — MODIFIZIERT)
   - Neuer ImportStep 'mapping' (zwischen analyzing und review)
   - Bekannte Waagen-Formate: direkt zu Review (wie bisher)
   - Generische CSVs: Mapping-Step → User bestätigt → Review
   - csvData + mappings State jetzt aktiv genutzt (nicht mehr _unused)

**Phase C: Deployment-Vorbereitung**

10. **vercel.json** (`vercel.json` — NEU)
    - SPA-Rewrites: alle Routes → /index.html
    - Asset-Caching: 1 Jahr immutable fuer /assets/*

11. **CI/CD** (`.github/workflows/ci.yml` — MODIFIZIERT)
    - Neuer Security-Check: grep nach API-Keys im Bundle
    - Deploy-Job: Vercel --prod, nur bei Push auf master
    - Build-Env: VITE_AI_PROVIDER=supabase fuer Prod

12. **.env.example** (`.env.example` — MODIFIZIERT)
    - Ausfuehrliche Dokumentation aller Varianten (Local/Cloud)
    - Server-Side Secrets Hinweis (OPENAI_API_KEY, RESEND_API_KEY)

13. **Deploy-Check Script** (`scripts/check-deploy.sh` — NEU)
    - Baut, prueft auf API-Key-Leaks, verifiziert Bundle-Integritaet

**Dateien:** 6 neu, 11 modifiziert
**Build:** 0 Fehler, ~2.262 KB JS, 54 KB CSS
**Tests:** 1.410 — alle gruen

---

---

### v10.9a — Musik/Timer Analyse & Konzept (2026-02-27)

**Was:** Code-Analyse der bestehenden Musik- und Timer-Implementierung, Root-Cause-Analyse der Probleme, Konzept-Dokument fuer die Ueberarbeitung erstellt.

**Analyse-Ergebnis:**

| Bereich | Status | Problem |
|---------|--------|---------|
| YouTube Audio | Komplett kaputt | IFrame API nie geladen, iframe unsichtbar (Autoplay blockiert), postMessage wirkungslos |
| Uebung ueberspringen | Feature existiert | Aber im ⋮ Menu versteckt — User hat es nicht gefunden |
| Timer deaktivieren | Feature existiert | Winziger Icon-Button im Header — User hat es nicht erkannt |
| Multi-Timer | Fehlt komplett | ManualTimer kann nur 1 Zeit tracken, User will 5 Sektionen |

**Konzept erstellt (`docs/MUSIK_TIMER_KONZEPT.md`):**

1. **Musik:** YouTube IFrame API korrekt laden + sichtbarer Mini-Player + Spotify Deep-Links als Alternative
2. **Timer:** Tabellarischer Multi-Timer mit 5 unabhaengigen Sektionen (Gesamttraining, Uebung, Uebungspause, Set, Setpause), jede separat aktivierbar/deaktivierbar
3. **UX:** Skip als prominenter Button (nicht Menu), Timer ON/OFF als Switch (nicht Icon)

**Dateien:** 1 neu (MUSIK_TIMER_KONZEPT.md), 2 modifiziert (TODO.md, FORTSCHRITT.md)
**Geschaetzter Aufwand Implementierung:** ~16h (M1-M3 + T1-T5)
**Status:** Konzept fertig, User-Diskussion ausstehend

---

*Letzte Aktualisierung: 2026-02-27*
