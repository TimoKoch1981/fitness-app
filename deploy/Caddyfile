# FitBuddy — Caddy Reverse Proxy
# Auto-SSL via Let's Encrypt, HTTP/2 + HTTP/3
#
# {$DOMAIN} wird aus der Umgebungsvariable gelesen,
# z.B. DOMAIN=fitbuddy.app

# www → non-www Redirect
www.{$DOMAIN} {
	redir https://{$DOMAIN}{uri} permanent
}

{$DOMAIN} {
	# Frontend — Static SPA
	handle {
		root * /srv/frontend
		try_files {path} /index.html
		file_server

		# Cache static assets (Vite hashed filenames → immutable)
		@assets path /assets/*
		header @assets Cache-Control "public, max-age=31536000, immutable"

		# index.html & other HTML → never cache (so deploys take effect immediately)
		@html {
			not path /assets/*
			path *.html /
		}
		header @html Cache-Control "no-cache, no-store, must-revalidate"
	}

	# Supabase API — Proxy zu Kong
	handle /rest/* {
		reverse_proxy kong:8000
	}

	handle /auth/* {
		reverse_proxy kong:8000
	}

	handle /realtime/* {
		reverse_proxy kong:8000
	}

	handle /storage/* {
		reverse_proxy kong:8000
	}

	handle /functions/* {
		reverse_proxy kong:8000
	}

	# Security Headers (hardened, 2026-03-01)
	header {
		# Prevent MIME-type sniffing
		X-Content-Type-Options nosniff
		# Prevent clickjacking
		X-Frame-Options DENY
		# Referrer policy — send origin only for cross-origin requests
		Referrer-Policy strict-origin-when-cross-origin
		# Permissions Policy — camera/microphone for voice input + video
		Permissions-Policy "camera=(self), microphone=(self), geolocation=(), payment=()"
		# Remove server identification
		-Server

		# HSTS — Force HTTPS for 1 year, include subdomains
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		# Legacy XSS Protection (still useful for older browsers)
		X-XSS-Protection "1; mode=block"
		# Cross-Origin Opener Policy — isolate browsing context
		Cross-Origin-Opener-Policy same-origin-allow-popups
		# Cross-Origin Resource Policy — only same-origin can load resources
		Cross-Origin-Resource-Policy same-origin

		# Content-Security-Policy (CSP)
		# - self: SPA assets, API calls via same-origin proxy
		# - YouTube/Spotify frames: Workout music player
		# - blob:/data: for image uploads, QR codes, share cards
		# - unsafe-inline styles: Tailwind CSS + Framer Motion + inline styles
		# - wss: for Supabase Realtime websockets
		Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https://world.openfoodfacts.org; font-src 'self'; connect-src 'self' wss://{$DOMAIN}; frame-src https://www.youtube.com https://www.youtube-nocookie.com https://open.spotify.com https://accounts.spotify.com; media-src 'self' blob:; worker-src 'self' blob:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'"
	}

	# Compression
	encode gzip zstd

	# Logging
	log {
		output file /var/log/caddy/fitbuddy.log {
			roll_size 10mb
			roll_keep 5
		}
	}
}

# Studio — nur intern erreichbar (Port 3000 via SSH Tunnel)
:3000 {
	reverse_proxy studio:3000
}
